<!doctype html>
<html class="theme-next use-motion ">
<head>
    

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />





  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.4"/>




  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.4" />


<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="helonghua">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="helonghua">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="helonghua">
<meta name="twitter:description">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post'
  };
</script>

    <title> helonghua </title>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->



<div class="container one-column 
   page-home 
">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">helonghua</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-tags"></i> <br />
            标签
          </a>
        </li>
      
    </ul>
  

  
</nav>


        </div>
    </header>

    <main id="main" class="main">
        <div class="main-inner">
            <div id="content" class="content">
                
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/23/nginx-lua-module-install/" itemprop="url">
                nginx lua module install
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-23T13:29:44+08:00" content="2015-12-23">
            2015-12-23
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="nginx_lua_module_install">nginx lua module install</h1><p>[TOC]</p>
<p>nginx与lua结合的项目最先OpenResty这个团队组织的。目前市场上用的最多的两个版本：Tengine 与 lua-nginx-module<br>有一句话评价很到位：<code>OpenResty是Nginx的Bundle；而Tengine则是Nginx的Fork</code>.相比来讲，OpenResty维护的项目自由度更好一点，当然他们好像都是taobao的。</p>
<p>为什么需要lua：</p>
<blockquote>
<p>nginx本身只是一个高性能,轻量级web服务器，借助lua，可以做很多业务相关的事情，比如和redis，memcache，DNS以及构建waf。性能可以提升很大。</p>
</blockquote>
<h2 id="安装">安装</h2><p>最好的安装顺序是：</p>
<ul>
<li>lua</li>
<li>下载lua-nginx-module 和 ngx_devel_kit</li>
<li>下载nginx 编译安装nginx</li>
</ul>
<p>我的电脑之前已经有nginx，而且是mac 下用brew安装的，配置了很多东西，并不像卸载。nginx又不能动态安装模块。<br>解决办法：下载一个和你当前nginx版本一样的nginx编译安装，然后替换nginx执行文件</p>
<ol>
<li>获取当前版本编译参数：<br><code>nginx -V</code></li>
</ol>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--prefix=/usr/<span class="keyword">local</span>/Cellar/nginx/1.8.0 --with-http_ssl_module --with-pcre --with-ipv6 --sbin-path=/usr/<span class="keyword">local</span>/Cellar/nginx/1.8.0/bin/nginx --with-<span class="keyword">cc</span>-opt='-I/usr/<span class="keyword">local</span>/Cellar/pcre/8.38/<span class="keyword">include</span> -I/usr/<span class="keyword">local</span>/Cellar/openssl/1.0.2e/<span class="keyword">include</span>' --with-ld-opt='-<span class="keyword">L</span>/usr/<span class="keyword">local</span>/Cellar/pcre/8.38/lib -<span class="keyword">L</span>/usr/<span class="keyword">local</span>/Cellar/openssl/1.0.2e/lib' --<span class="keyword">conf</span>-path=/usr/<span class="keyword">local</span>/etc/nginx/nginx.<span class="keyword">conf</span> --pid-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">run</span>/nginx.pid --lock-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">run</span>/nginx.lock --http-client-body-temp-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">run</span>/nginx/client_body_temp --http-proxy-temp-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">run</span>/nginx/proxy_temp --http-fastcgi-temp-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">run</span>/nginx/fastcgi_temp --http-uwsgi-temp-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">run</span>/nginx/uwsgi_temp --http-scgi-temp-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">run</span>/nginx/scgi_temp --http-<span class="keyword">log</span>-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">log</span>/nginx/access.<span class="keyword">log</span> --<span class="keyword">error</span>-<span class="keyword">log</span>-path=/usr/<span class="keyword">local</span>/<span class="keyword">var</span>/<span class="keyword">log</span>/nginx/<span class="keyword">error</span>.<span class="keyword">log</span> --with-http_gzip_static_module</span><br></pre></td></tr></table></figure>
<ol>
<li>安装lua或者luajit</li>
</ol>
<p>mac命令：<code>brew install luajit</code></p>
<ol>
<li>重新编译nginx</li>
</ol>
<p>重新编译之前，先设定变量：</p>
<pre><code># export LUAJIT_LIB=<span class="regexp">/usr/</span>local<span class="regexp">/Cellar/</span>luajit<span class="regexp">/2.0.3_1/</span>lib
# export LUAJIT_INC=<span class="regexp">/usr/</span>local<span class="regexp">/Cellar/</span>luajit<span class="regexp">/2.0.3_1/i</span>nclude<span class="regexp">/luajit-2.0</span>
</code></pre><p><strong>添加参数：</strong><br>在末尾加上<code>--add-module=/Users/helonghua/lua-nginx-module --add-module=/Users/helonghua/ngx_devel_kit-0.2.19</code><br>同时，一定要确认—with-cc-opt 和  —with-ld-opt 这个路径的正确性</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/configure --prefix=/u</span>sr<span class="regexp">/local/</span>Cellar<span class="regexp">/nginx/</span><span class="number">1.8</span>.<span class="number">0</span> --with-http_ssl_module --with-pcre --with-ipv6 --sbin-path=<span class="regexp">/usr/</span>local<span class="regexp">/Cellar/</span>nginx<span class="regexp">/1.8.0/</span>bin<span class="regexp">/nginx --with-cc-opt='-I/u</span>sr<span class="regexp">/local/</span>Cellar<span class="regexp">/pcre/</span><span class="number">8.38</span><span class="regexp">/include -I/u</span>sr<span class="regexp">/local/</span>Cellar<span class="regexp">/openssl/</span><span class="number">1.0</span>.<span class="number">2</span>e<span class="regexp">/include' --with-ld-opt='-L/u</span>sr<span class="regexp">/local/</span>Cellar<span class="regexp">/pcre/</span><span class="number">8.38</span><span class="regexp">/lib -L/u</span>sr<span class="regexp">/local/</span>Cellar<span class="regexp">/openssl/</span><span class="number">1.0</span>.<span class="number">2</span>e<span class="regexp">/lib' --conf-path=/u</span>sr<span class="regexp">/local/</span>etc<span class="regexp">/nginx/</span>nginx.conf --pid-path=<span class="regexp">/usr/</span>local<span class="regexp">/var/</span>run<span class="regexp">/nginx.pid --lock-path=/u</span>sr<span class="regexp">/local/</span>var<span class="regexp">/run/</span>nginx.lock --http-client-body-temp-path=<span class="regexp">/usr/</span>local<span class="regexp">/var/</span>run<span class="regexp">/nginx/</span>client_body_temp --http-proxy-temp-path=<span class="regexp">/usr/</span>local<span class="regexp">/var/</span>run<span class="regexp">/nginx/</span>proxy_temp --http-fastcgi-temp-path=<span class="regexp">/usr/</span>local<span class="regexp">/var/</span>run<span class="regexp">/nginx/</span>fastcgi_temp --http-uwsgi-temp-path=<span class="regexp">/usr/</span>local<span class="regexp">/var/</span>run<span class="regexp">/nginx/u</span>wsgi_temp --http-scgi-temp-path=<span class="regexp">/usr/</span>local<span class="regexp">/var/</span>run<span class="regexp">/nginx/</span>scgi_temp --http-log-path=<span class="regexp">/usr/</span>local<span class="regexp">/var/</span>log<span class="regexp">/nginx/</span>access.log --error-log-path=<span class="regexp">/usr/</span>local<span class="regexp">/var/</span>log<span class="regexp">/nginx/</span>error.log --with-http_gzip_static_module --add-module=<span class="regexp">/Users/</span>helonghua<span class="regexp">/lua-nginx-module --add-module=/U</span>sers<span class="regexp">/helonghua/</span>ngx_devel_kit-<span class="number">0.2</span>.<span class="number">19</span></span><br></pre></td></tr></table></figure>
<p><strong>编译（只要make不要make install）：</strong></p>
<pre><code>#make
<span class="comment">//删除原nginx</span>
#rm -rf  <span class="regexp">/usr/</span>local<span class="regexp">/Cellar/</span>nginx<span class="regexp">/1.8.0/</span>bin/nginx
#cp objs<span class="regexp">/nginx /</span>usr<span class="regexp">/local/</span>Cellar<span class="regexp">/nginx/</span><span class="number">1.8</span>.0<span class="regexp">/bin/</span>
</code></pre><p><strong>启动</strong></p>
<pre><code><span class="regexp">/usr/</span>local<span class="regexp">/Cellar/</span>nginx<span class="regexp">/1.8.0/</span>bin<span class="regexp">/nginx</span>
</code></pre><p><strong>测试</strong></p>
<pre><code><span class="comment">//找一个域名server，添加</span>
location /hello {
       default_type 'text/plain';
       content_by_lua 'ngx.say(<span class="string">"hello, lua"</span>)';
}
</code></pre><p><code>nginx -t</code>是否报错</p>
<p>打开网址测试：<a href="http://127.0.0.1/hello" target="_blank" rel="external">http://127.0.0.1/hello</a></p>
<h2 id="nginx_lua在waf上应用">nginx lua在waf上应用</h2><p>github:<a href="https://github.com/loveshell/ngx_lua_waf" target="_blank" rel="external">https://github.com/loveshell/ngx_lua_waf</a></p>
<p>测试了一下，AB压测的确很简单的被防御了。应该CC攻击也没有问题，其中也过滤了很多常用的注入手段</p>
<p>对比：<a href="http://helonghua.com/2015/05/12/limit-zone-limie-req-zone/" target="_blank" rel="external">mit_zone、limie_req_zone nginx</a>自带的这两个模块。还是这个强大，好用</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/10/20/php-session/" itemprop="url">
                php session
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-10-20T23:22:34+08:00" content="2015-10-20">
            2015-10-20
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>[toc]</p>
<p>最近由于承接了麦当娜微信公众号码抽奖活动开发。微软云主机给了3台高配置centos虚拟机。由于负责服务器搭建这一块，所以对负载均衡中session的问题有新的认识；</p>
<h2 id="session存在的问题">session存在的问题</h2><p>关于session的基础原理，可以参看<br>PHP session的内核：<a href="http://blog.csdn.net/ohmygirl/article/details/43152683" target="_blank" rel="external">http://blog.csdn.net/ohmygirl/article/details/43152683</a></p>
<p>php.ini中默认session.save_handler=files其实是有一定的弊端的</p>
<h3 id="session文件锁">session文件锁</h3><p>如果session信息以文件方式存储，好几个脚本同时对一个session文件进行修改，读取，等操作，会出现阻塞情况；</p>
<blockquote>
<p>在session/mod_files.c中ps_files_open函数中追踪到这样一句：<br>flock(data-&gt;fd, LOCK_EX);<br>由于是LOCK_EX（互斥锁）,因而在文件锁定期间，即使是读取文件的数据也是不允许的。这就造成要写入或读取的进程必须等待，直到前一进程释放锁（这通常发生在脚本执行完毕或者用户调用</p>
</blockquote>
<h3 id="session-save_path层级问题">session.save_path层级问题</h3><p>session.save<em>path 默认是/tmp目录。如果不设置层级的话，/tmp目录会出现几万个sess</em>*的文件<br>，文件读取性能很差</p>
<p><strong>如果要分层</strong></p>
<ul>
<li>目录php不会自己生成</li>
<li>php不会自己gc回收</li>
</ul>
<p>正常我们如果设置层级的话一般3层最为普遍，不过3层目录php不会自己生成，php有自带的生成脚本<br>php源码包找到：ext/session/mod_files.sh<br>执行: <code>bash mod_files.sh /tmp/session 3 5</code><br>3:代表3层<br>5:对应于php.ini中的 session.hash_bits_per_character,这个值默认是4，development和production版本的默认配置里是5、执行前先看一下这个值session.hash_bits_per_character</p>
<p>生成目录需要一部分时间，记得给权限！！！</p>
<p><strong>关于过期session文件回收：</strong></p>
<pre><code><span class="keyword">find</span> <span class="regexp">/tmp/</span>session  -amin +<span class="number">180</span> -exec rm -rf {} \;
</code></pre><p>这个脚本的意思是获取/tmp/session 目录下文件最后一次操作时间是180分钟之前的文件，进行删除<br>可以放到crontab里面，1分钟执行一次</p>
<h3 id="session共享以及磁盘IO问题">session共享以及磁盘IO问题</h3><p>这个就是以下要说的重点了，此次部署采用的redis存储session，避免了这两个问题</p>
<h2 id="分布式环境共享session">分布式环境共享session</h2><p>分布式环境共享session有很多种方法：</p>
<ol>
<li>服务器session文件实时同步</li>
<li>nginx 负载均衡 ip_hash</li>
<li>nosql存储</li>
</ol>
<p>如果不采用nosql，第二种是最简单，直接的。一个ip的用户固定将请求打到一台服务器上</p>
<p>我采用的redis来存储，至于为啥不用memcache，考虑的原因是redis操作便捷性比memcache强很多；<br>另一个角度来讲redis hset这个hash数据结构更适合存储session</p>
<h3 id="采用redis存储session">采用redis存储session</h3><h4 id="自定义封装类操作session">自定义封装类操作session</h4><p>如果系统依赖session存储很多东西，或者是对session的操作很复杂，建议自己封装php类来操作session存取redis</p>
<p>参考文章：<a href="http://blog.chinaunix.net/uid-11121450-id-3284875.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-11121450-id-3284875.html</a></p>
<p>这种写法，session的扩展性强了许多；</p>
<h4 id="系统直接接入">系统直接接入</h4><p>秀代码：</p>
<pre><code>ini_<span class="built_in">set</span>(<span class="string">'session.save_handler'</span>, <span class="string">'redis'</span>);
ini_<span class="built_in">set</span>(<span class="string">'session.save_path'</span>, <span class="string">'tcp://127.0.0.1:6379'</span>);
ini_<span class="built_in">set</span>(<span class="string">'session.name'</span>, <span class="string">'hahatest'</span>);
ini_<span class="built_in">set</span>(<span class="string">'session.gc_maxlifetime'</span>, <span class="string">'7200'</span>);
</code></pre><p>在入口文件，直接这么写就没事了，存文件的时候session怎么写，现在还是怎么写，这样比较适合从存文件这种方式，直接切换到redis</p>
<p>同理memcache也是如此写法；</p>
<h2 id="CI框架特有的session">CI框架特有的session</h2><p>CI框架的session坑了我一把，一开始怎么都没有找到session存放的位置；</p>
<p>CI彻底抛弃了php session 的存储方式，session加密之后都放到客户端了</p>
<p>关于这个问题不是本文要讨论的，不过这也是别样session的实现方式，更多问题请百度</p>
<h2 id="问答">问答</h2><p>如何设置一个30分钟过期的Session</p>
<p>鸟哥的博客都是精品：</p>
<p><a href="http://www.laruence.com/2012/01/10/2469.html" target="_blank" rel="external">http://www.laruence.com/2012/01/10/2469.html</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/21/workerman-websocket/" itemprop="url">
                PHP websocket 框架workerman
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-21T02:17:13+08:00" content="2015-09-21">
            2015-09-21
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="PHP_websocket_框架workerman">PHP websocket 框架workerman</h1><p>前言：websocket 双屏互动小游戏大部分都是用 nodejs + redis 来构建服务层的，自己也接触过一些。不过本文要说的是PHP在这方面也毫不逊色</p>
<p>PHP在低版本就已经提供了很多socket方面的函数，由于各种原因，这些函数出镜率不高，基本被大家扔在垃圾堆里了。剩下最好用的应该也是：stream<em>socket</em>* 函数。</p>
<ul>
<li>stream_socket_server</li>
<li>stream_socket_accept</li>
<li>stream_socket_recvfrom</li>
<li>stream_socket_client</li>
</ul>
<p>workerman就是基于这几个函数构建的；</p>
<h2 id="workerman_认识">workerman 认识</h2><p>看了一下workerman代码示例，到处飘散着反人类的气息，各种PHP匿名函数，闭包回调，正常来讲，这在PHP里面很少见。</p>
<p>严格来讲workerman不算一个框架，更像一个工具，一个基于libevent、pcntl、posix 这几个扩展，以及socket协议的工具。</p>
<p>工作流程图：<br><img src="http://ww4.sinaimg.cn/large/005ItG0Rjw1ew9ggpijqqj314q11o12x.jpg" alt=""></p>
<p>采用master fork worker 模式。所以必须依赖pcntl扩展，<br>为了使用epoll 必须使用php libevent扩展</p>
<p>详细写法查看：Worker.php这个文件</p>
<h2 id="workerman_server">workerman server</h2><p>workermain自带webserver，不过这个webserver还是不够强大。基于Worker这个类，监听server端口，将所有的字符串拼装完之后，接上http头部返回给浏览器，一个基本的webserver就完成了。</p>
<p>不过框架的优势是做php websocket服务端端，并不是web server 解析</p>
<h2 id="websocket例子">websocket例子</h2><p><img src="http://ww4.sinaimg.cn/large/005ItG0Rjw1ew9gqpxmm6j30y80oqmzo.jpg" alt=""></p>
<p>一个简单的websocket例子，监控机器的性能。<br>部署代码非常简单，直接启用start.php即可。</p>
<p>http访问建立有两种方式，一种是nginx 访问，一种是workerman自带的web server 。验证都是可以正常实现的。</p>
<p>官方github：<a href="https://github.com/walkor/workerman-vmstat" target="_blank" rel="external">https://github.com/walkor/workerman-vmstat</a></p>
<p>更多内容，下次再分享</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/09/a-sample-javascript-template/" itemprop="url">
                JavaScript模板引擎原理
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-09T01:40:54+08:00" content="2015-09-09">
            2015-09-09
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>[TOC]</p>
<h2 id="前言">前言</h2><p>什么是模板引擎，说的简单点，就是一个字符串中有几个变量待定。比如：</p>
<pre><code>var tpl = 'Hei, <span class="keyword">my</span> <span class="property">name</span> <span class="keyword">is</span> &lt;%<span class="property">name</span>%&gt;, <span class="keyword">and</span> I\'m &lt;%age%&gt; years old.';
</code></pre><p>通过模板引擎函数把数据塞进去，</p>
<pre><code><span class="keyword">var</span> data = {
    <span class="string">"name"</span>: <span class="string">"Barret Lee"</span>,
    <span class="string">"age"</span>: <span class="string">"20"</span>
};

<span class="keyword">var</span> <span class="literal">result</span> = tplEngine(tpl, data);
//<span class="type">Hei</span>, my name <span class="keyword">is</span> <span class="type">Barret</span> <span class="type">Lee</span>, <span class="keyword">and</span> I'm <span class="number">20</span> years old.
</code></pre><p>JS模板引擎应该做哪些事情</p>
<pre><code>var tpl = <span class="comment">'<span class="xmlDocTag">&lt;% for(var i = 0; i &lt; this.posts.length; i++) {' +　
    'var post = posts[i]; %&gt;</span>' +</span>
    <span class="comment">'<span class="xmlDocTag">&lt;% if(!post.expert){ %&gt;</span>' +</span>
    <span class="comment">'<span class="xmlDocTag">&lt;span&gt;</span>post is null<span class="xmlDocTag">&lt;/span&gt;</span>' +</span>
    <span class="comment">'<span class="xmlDocTag">&lt;% } else { %&gt;</span>' +</span>
    <span class="comment">'<span class="xmlDocTag">&lt;a href="#"&gt;</span><span class="xmlDocTag">&lt;% post.expert %&gt;</span> at <span class="xmlDocTag">&lt;% post.time %&gt;</span><span class="xmlDocTag">&lt;/a&gt;</span>' +</span>
    <span class="comment">'<span class="xmlDocTag">&lt;% } %&gt;</span>' +</span>
<span class="comment">'<span class="xmlDocTag">&lt;% } %&gt;</span>';</span>
</code></pre><p>送入的数据是：</p>
<pre><code><span class="variable"><span class="keyword">var</span> data</span> = {
    <span class="string">"posts"</span>: [{
        <span class="string">"expert"</span>: <span class="string">"content 1"</span>,
        <span class="string">"time"</span>: <span class="string">"yesterday"</span>
    },{
        <span class="string">"expert"</span>: <span class="string">"content 2"</span>,
        <span class="string">"time"</span>: <span class="string">"today"</span>
    },{
        <span class="string">"expert"</span>: <span class="string">"content 3"</span>,
        <span class="string">"time"</span>: <span class="string">"tomorrow"</span>
    },{
        <span class="string">"expert"</span>: <span class="string">""</span>,
        <span class="string">"time"</span>: <span class="string">"eee"</span>
    }]
};
</code></pre><p>输出：</p>
<pre><code>&lt;<span class="operator">a</span> href=<span class="string">"#"</span>&gt;content <span class="number">1</span> <span class="keyword">at</span> yesterday&lt;/<span class="operator">a</span>&gt;
&lt;<span class="operator">a</span> href=<span class="string">"#"</span>&gt;content <span class="number">2</span> <span class="keyword">at</span> today&lt;/<span class="operator">a</span>&gt;
&lt;<span class="operator">a</span> href=<span class="string">"#"</span>&gt;content <span class="number">3</span> <span class="keyword">at</span> tomorrow&lt;/<span class="operator">a</span>&gt;
&lt;span&gt;<span class="built_in">post</span> is <span class="constant">null</span>&lt;/span&gt;
</code></pre><h2 id="JS模板引擎的实现原理">JS模板引擎的实现原理</h2><p><strong>1.正则抠出要匹配的内容</strong><br>针对这一串代码，通过正则获取内容</p>
<pre><code>var tpl = 'Hei, <span class="keyword">my</span> <span class="property">name</span> <span class="keyword">is</span> &lt;%<span class="property">name</span>%&gt;, <span class="keyword">and</span> I\'m &lt;%age%&gt; years old.';
var data = {
    <span class="string">"name"</span>: <span class="string">"Barret Lee"</span>,
    <span class="string">"age"</span>: <span class="string">"20"</span>
};
</code></pre><p>最简单的方式就是通过replace函数了：</p>
<pre><code><span class="keyword">var</span> <span class="literal">result</span> = tpl.replace(/&lt;%([^%&gt;]+)?%&gt;/g, function(s0, s1){
    <span class="keyword">return</span> data[s1];
});
</code></pre><p> 通过正则替换，我们很轻松的拿到了result，你可以去试一试，他正式我们想要的结果。但是这里又有了一个问题，改一下data和tpl，</p>
<pre><code>var tpl = 'Hei, <span class="keyword">my</span> <span class="property">name</span> <span class="keyword">is</span> &lt;%<span class="property">name</span>%&gt;, <span class="keyword">and</span> I\'m &lt;%info.age%&gt; years old.';

var data = {
    <span class="string">"name"</span>: <span class="string">"Barret Lee"</span>,
    <span class="string">"info"</span>: { age<span class="string">": "</span><span class="number">20</span><span class="string">"}
};</span>
</code></pre><p> 再用上面的方式去获取结果，呵呵，不行了吧~ 这里data[“info.age”]本身就是undefined，所以我们需要换一种方式来处理这个问题，那就是将它转换成真正的JS代码。如：</p>
<pre><code>return <span class="string">'Hei, my name is '</span> + data<span class="class">.name</span> + <span class="string">', and I\'m '</span> + data<span class="class">.info</span><span class="class">.age</span><span class="string">' + '</span> years old.<span class="string">'</span>
</code></pre><p> 但是接着又有一个问题来了，当我们的代码中出现for循环和if的时候，上面的转换明显是不起作用的，如：</p>
<pre><code>var <span class="variable">tpl =</span> 'Posts: ' +
    '&lt;% for(<span class="variable">var=</span><span class="string">""</span> <span class="variable">i=</span><span class="string">"0;"</span> &lt;=<span class="string">""</span> post.length;=<span class="string">""</span> i++)=<span class="string">""</span> {'+=<span class="string">""</span> '&lt;<span class="variable">a=</span><span class="string">""</span> <span class="variable">href=</span><span class="string">"#"</span>&gt;&lt;% post[i].<span class="variable">expert=</span><span class="string">""</span> %=<span class="string">""</span>&gt;' +
    '&lt;% }=<span class="string">""</span> %=<span class="string">""</span>&gt;'
</code></pre><p> 如果继续采用上面的方式，得到的结果便是：</p>
<pre><code><span class="keyword">return</span> <span class="string">'Posts: '</span> +
       <span class="keyword">for</span>(var <span class="built_in">i</span> = <span class="number">0</span>; <span class="built_in">i</span> &lt; post.<span class="built_in">length</span>; <span class="built_in">i</span>++) <span class="cell">{ +
         <span class="string">'&lt;a href="#"&gt;'</span> + post[i].exper + <span class="string">'&lt;/a&gt;'</span> +
       }</span>
</code></pre><p> 这显然不是我们愿意看到的，稍微观察一下上面的结构，如果可以返回一个这样的结果也挺不错哦：</p>
<pre><code><span class="string">'Posts: '</span>
<span class="keyword">for</span>(var <span class="built_in">i</span> = <span class="number">0</span>; <span class="built_in">i</span> &lt; post.<span class="built_in">length</span>; <span class="built_in">i</span>++) <span class="cell">{
    <span class="string">'&lt;a href="#"&gt;'</span> + post[i].exper + <span class="string">'&lt;/a&gt;'</span>
}</span>
</code></pre><p> 但是我们需要得到的是一个字符串，而不是上面这样零散的片段，因此可以把这些东西装入数组中。</p>
<p><strong>2.装入数组</strong></p>
<pre><code>var r = [];
r.push<span class="comment">('Posts: ' )</span>;
r.push<span class="comment">(for(var i = 0; i &lt; post.length; i++)</span> {);
r.push<span class="comment">('&lt;a href="#"&gt;')</span>;
r.push<span class="comment">(post[i].exper)</span>;
r.push<span class="comment">('&lt;/a&gt;')</span>;
r.push<span class="comment">(})</span>;
</code></pre><p> 有人看到上面的代码就要笑了，第三行和最后一行代码的逻辑明显是不正确的嘛，那肿么办呢？呵呵，很简单，不放进去就行了呗，</p>
<pre><code>var r = [];
r.push<span class="comment">('Posts: ' )</span>;
for<span class="comment">(var i = 0; i &lt; post.length; i++)</span> {
    r.push<span class="comment">('&lt;a href="#"&gt;')</span>;
    r.push<span class="comment">(post[i].exper)</span>;
    r.push<span class="comment">('&lt;/a&gt;')</span>;
}
</code></pre><p> 这样的逻辑就十分完善了，不存在太多的漏洞，但是这个转化的过程是如何实现的？我们必须还是要写一个解析的模板函数出来。</p>
<p><strong>3.分辨js逻辑部分</strong></p>
<pre><code><span class="keyword">var</span> r = [];
tpl.replace(<span class="regexp">/&lt;%([^%&gt;]+)?%&gt;/g</span>, <span class="function"><span class="keyword">function</span><span class="params">(s0, s1)</span></span>{
    <span class="comment">//完蛋了，这里貌似又要回到上面那可笑的逻辑有错误的一步啦... 该怎么处理比较好？</span>
});
</code></pre><p> 完蛋了，这里貌似又要回到上面那可笑的逻辑有错误的一步啦… 该怎么处理比较好？我们知道，JS给我们提供了构造函数的\类”，</p>
<pre><code><span class="keyword">var</span> fn = <span class="keyword">new</span> <span class="function"><span class="keyword">Function</span><span class="params">("data",
    "<span class="keyword">var</span> r = []; <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> data)</span><span class="comment">{ r.push(data[i]); }</span> <span class="title">return</span> <span class="title">r</span>.<span class="title">join</span><span class="params">(<span class="string">' '</span>)</span>");</span>
fn(<span class="comment">{"name": "barretlee", "age": "20"}</span>); <span class="comment">// barretlee 20</span>
</code></pre><p> 知道了这个就好办了，我们可以把逻辑部分和非逻辑部分的代码链接成一个字符串，然后利用类似fn的函数直接编译代码。而/&lt;%([^%&gt;]+)?%&gt;/g，这一个正则只能把逻辑部分匹配出来，要想把所有的代码都组合到一起，必须还得匹配非逻辑部分代码。replace函数虽然很强大，他也可以完成这个任务，但是实现的逻辑比较晦涩，所以我们换另外一种方式来处理。</p>
<p>先看一个简单的例子：</p>
<pre><code>var reg = /&lt;<span class="variable">%(</span>[^<span class="variable">%&gt;</span>]+)?<span class="variable">%&gt;</span>/g;
var tpl = <span class="string">'Hei, my name is &lt;%name%&gt;, and I\'m &lt;%age%&gt; years old.'</span>;
var <span class="keyword">match</span> = reg.<span class="keyword">exec</span>(tpl);
console.<span class="keyword">log</span>(<span class="keyword">match</span>);
</code></pre><p>看到的是：</p>
<pre><code>[
    <span class="number">0</span>: <span class="string">"&lt;%name%&gt;"</span>,
    <span class="number">1</span>: name,
    index: <span class="number">16</span>,
    input: <span class="string">"Hei, my name is &lt;%name%&gt;, and I'm &lt;%age%&gt; years old."</span>
    length: <span class="number">2</span>
]
</code></pre><p> 这。。。我们可是想得到所有的匹配啊，他竟然只获取了name而忽略了后面的age，好吧，对正则稍微熟悉点的童鞋一定会知道应该这样处理：</p>
<pre><code>var reg = /&lt;<span class="variable">%(</span>[^<span class="variable">%&gt;</span>]+)?<span class="variable">%&gt;</span>/g;
<span class="keyword">while</span>(<span class="keyword">match</span> = reg.<span class="keyword">exec</span>(tpl)) {
    console.<span class="keyword">log</span>(<span class="keyword">match</span>);
}
</code></pre><p> 关于正则表达式的内容就不在这里细说了，有兴趣的同学可以多去了解下match,exec,search等正则的相关函数。这里主要是靠match的index属性来定位遍历位置，然后利用while循环获取所有的内容。</p>
<p><strong>4.引擎函数</strong></p>
<p>所以我们的引擎函数雏形差不多就出来了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> tplEngine = <span class="function"><span class="keyword">function</span><span class="params">(tpl, data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="regexp">/&lt;%([^%&gt;]+)?%&gt;/g</span>,</span><br><span class="line">    code = <span class="string">'var r=[];\n'</span>,</span><br><span class="line">    cursor = <span class="number">0</span>; <span class="comment">//主要的作用是定位代码最后一截</span></span><br><span class="line">    <span class="keyword">var</span> add = <span class="function"><span class="keyword">function</span><span class="params">(line)</span> </span>&#123;</span><br><span class="line">        code += <span class="string">'r.push("'</span> + line.replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>) + <span class="string">'");\n'</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (match = reg.exec(tpl)) &#123;</span><br><span class="line">        add(tpl.slice(cursor, match.index)); <span class="comment">//添加非逻辑部分</span></span><br><span class="line">        add(match[<span class="number">1</span>]); <span class="comment">//添加逻辑部分 match[0] = "&lt;%" +="" match[1]="" "%=""&gt;";</span></span><br><span class="line">        cursor = match.index + match[<span class="number">0</span>].length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(tpl.substr(cursor, tpl.length - cursor)); <span class="comment">//代码的最后一截 如:" years old."</span></span><br><span class="line">    code += <span class="string">'return r.join("");'</span>; <span class="comment">// 返回结果，在这里我们就拿到了装入数组后的代码</span></span><br><span class="line">    <span class="built_in">console</span>.log(code);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tpl;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 这样一来，测试一个小demo:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="keyword">var</span> tpl = <span class="string">'&lt;% for(var="" i="0;" &lt;="" this.posts.length;="" i++)="" &#123;'</span>=<span class="string">""</span> +　=<span class="string">""</span> <span class="string">'var="" post="posts[i];" %=""&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;% if(!post.expert)&#123;="" %=""&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;span&gt;post is null&lt;/span&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;% &#125;="" else="" &#123;="" %=""&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;a href="#"&gt;&lt;% post.expert="" %=""&gt; at &lt;% post.time="" %=""&gt;&lt;/%&gt;&lt;/%&gt;&lt;/a&gt;'</span> +</span><br><span class="line">        <span class="string">'&lt;% &#125;="" %=""&gt;'</span> +</span><br><span class="line">    <span class="string">'&lt;% &#125;="" %=""&gt;'</span>;</span><br><span class="line">tplEngine(tpl, data);</span><br></pre></td></tr></table></figure>
<p> 返回的结果让人很满意：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">var r=[];</span><br><span class="line">r.push("");</span><br><span class="line">r.push(" for(var i = 0; i &lt; this.posts.length; i++) &#123;var post = posts[i]; ");</span><br><span class="line">r.push("");</span><br><span class="line">r.push(" if(!post.expert)&#123; ");</span><br><span class="line">r.push("&lt;span&gt;post is null&lt;/span&gt;");</span><br><span class="line">r.push(" &#125; else &#123; ");</span><br><span class="line">r.push("&lt;a href="\"#\""&gt;");</span><br><span class="line">r.push(" post.expert ");</span><br><span class="line">r.push(" at ");</span><br><span class="line">r.push(" post.time ");</span><br><span class="line">r.push("&lt;/a&gt;");</span><br><span class="line">r.push(" &#125; ");</span><br><span class="line">r.push("");</span><br><span class="line">r.push(" &#125; ");</span><br><span class="line">r.push("");</span><br><span class="line">return r.join("");</span><br></pre></td></tr></table></figure>
<p> 不过我们并需要for，if，switch等这些东西也push到r数组中去，所以呢，还得改善下上面的代码，如果在line中发现了包含js逻辑的代码，我们就不应该让他进门：</p>
<pre><code>regOut = /(^( )?(<span class="keyword">if</span>|<span class="keyword">for</span>|<span class="keyword">else</span>|switch|case|<span class="keyword">break</span>|{|}))(.*)?/<span class="keyword">g</span>;
<span class="keyword">var</span> add = function(<span class="keyword">line</span>, js) {
    js? code += <span class="keyword">line</span>.<span class="literal">match</span>(regOut) ? <span class="keyword">line</span> + '\<span class="keyword">n</span>' : 'r.push(' + <span class="keyword">line</span> + ');\<span class="keyword">n</span>' :
        code += 'r.push(<span class="string">"' + line.replace(/"</span>/<span class="keyword">g</span>, '\\<span class="string">"') + '"</span>);\<span class="keyword">n</span>';
};
</code></pre><p> 所以我们只剩下最后一步工作了，把data扔进去！</p>
<p><strong>5.把data扔进去</strong></p>
<p>没有比完成这东西更简单的事情啦，通过上面对Function这个函数的讲解，大家应该也知道怎么做了。</p>
<pre><code><span class="keyword">return</span> <span class="keyword">new</span> <span class="function"><span class="keyword">Function</span><span class="params">(code)</span>.<span class="title">apply</span><span class="params">(data)</span></span>;
</code></pre><p> 使用apply的作用就是让code中的一些变量作用域绑定到data上，不然作用域就会跑到global上，这样得到的数据索引就会出问题啦~ 当然我们可以再优化一下：</p>
<pre><code><span class="keyword">return</span> <span class="keyword">new</span> <span class="function"><span class="keyword">Function</span><span class="params">(code.replace<span class="params">(/[\r\t\n]/g, <span class="string">''</span>)</span>)</span>.<span class="title">apply</span><span class="params">(data)</span></span>;
</code></pre><p> 把回车换行以及tab键都给匹配掉，让代码更加干净一点。那么最终的代码就是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> tplEngine = <span class="function"><span class="keyword">function</span><span class="params">(tpl, data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="regexp">/&lt;%([^%&gt;]+)?%&gt;/g</span>,</span><br><span class="line">    regOut = <span class="regexp">/(^( )?(if|for|else|switch|case|break|&#123;|&#125;))(.*)?/g</span>,</span><br><span class="line">    code = <span class="string">'var r=[];\n'</span>,</span><br><span class="line">    cursor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> add = <span class="function"><span class="keyword">function</span><span class="params">(line, js)</span> </span>&#123;</span><br><span class="line">        js ? (code += line.match(regOut) ? line + <span class="string">'\n'</span>: <span class="string">'r.push('</span> + line + <span class="string">');\n'</span>) : (code += line != <span class="string">''</span> ? <span class="string">'r.push("'</span> + line.replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>) + <span class="string">'");\n'</span>: <span class="string">''</span>);</span><br><span class="line">        <span class="keyword">return</span> add;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (match = reg.exec(tpl)) &#123;</span><br><span class="line">        add(tpl.slice(cursor, match.index))(match[<span class="number">1</span>], <span class="literal">true</span>);</span><br><span class="line">        cursor = match.index + match[<span class="number">0</span>].length;</span><br><span class="line">    &#125;</span><br><span class="line">    add(tpl.substr(cursor, tpl.length - cursor));</span><br><span class="line">    code += <span class="string">'return r.join("");'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(code.replace(<span class="regexp">/[\r\t\n]/g</span>, <span class="string">''</span>)).apply(data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="应用">应用</h2><p>毕竟是前端代码，所以写出来是要为前端服务的，平时我们处理的一般是一个html的模板，通常的情况下，模板代码是放在script标签或者textarea中，所以首先是要获取到这里头的东西，然后再来做解析。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> barretTpl = <span class="function"><span class="keyword">function</span><span class="params">(str, data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取元素</span></span><br><span class="line">    <span class="keyword">var</span> element = <span class="built_in">document</span>.getElementById(str);</span><br><span class="line">    <span class="keyword">if</span> (element) &#123;</span><br><span class="line">        <span class="comment">//textarea或input则取value，其它情况取innerHTML</span></span><br><span class="line">        <span class="keyword">var</span> html = <span class="regexp">/^(textarea|input)$/i</span>.test(element.nodeName) ? element.value : element.innerHTML;</span><br><span class="line">        <span class="keyword">return</span> tplEngine(html, data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//是模板字符串，则生成一个函数</span></span><br><span class="line">        <span class="comment">//如果直接传入字符串作为模板，则可能变化过多，因此不考虑缓存</span></span><br><span class="line">        <span class="keyword">return</span> tplEngine(str, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> tplEngine = <span class="function"><span class="keyword">function</span><span class="params">(tpl, data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// content above</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样一来就更加简单了，使用方式就是 barretTpl(str, data)， 这里的str可以是模板代码，也可以是一个DOM元素的id~ 可以看看这两段代码：<a href="https://gist.github.com/barretlee/7765698" target="_blank" rel="external">https://gist.github.com/barretlee/7765698</a>, <a href="https://gist.github.com/barretlee/7765587" target="_blank" rel="external">https://gist.github.com/barretlee/7765587</a></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/07/29/php-ext-hello-word/" itemprop="url">
                PHP扩展hello word
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-07-29T23:40:39+08:00" content="2015-07-29">
            2015-07-29
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>[toc]</p>
<p>前言：记录文档</p>
<p>环境：mac 10.10.1</p>
<p>PHP版本：php5.6.6 自编译</p>
<hr>
<h2 id="一">一</h2><p>查看自己版本php <code>php -v</code></p>
<p>到官网下载相同版本的php包</p>
<p>解压之后进入：<code>php-5.6.6/ext/</code></p>
<p>执行： </p>
<pre><code>./ext_skel --extname=hello  <span class="comment">//这里我们假设开发一个 hello 的扩展</span>
</code></pre><p>ext_skel是php官方提供的扩展代码生成器</p>
<h2 id="二">二</h2><p><code>cd hello</code></p>
<p>打开生成的 <code>php-hello.h</code></p>
<p>末尾添加函数：</p>
<pre><code>PHP_FUNCTION<span class="list">(<span class="keyword">hello</span>)</span><span class="comment">;</span>
</code></pre><p>打开代码 hello.c, PHP_FE(confirm_hello_compiled, NULL) 后加一行</p>
<pre><code><span class="function"><span class="title">PHP_FE</span><span class="params">(hello,   NULL)</span></span>
</code></pre><p>然后，你可以在PHP_FUNCTION(confirm_widuu_compiled) 后定义一个函数，代码如下</p>
<pre><code>PHP_FUNCTION(hello){
    php_<span class="built_in">printf</span>(<span class="string">"hello word"</span>);
}
</code></pre><p>在修改 config.m4 中的文件，去除这三行文件前边的dnl，如下效果</p>
<pre><code>PHP_ARG_ENABLE(hello, whether <span class="keyword">to</span> enable hello support,
Make sure <span class="keyword">that</span> <span class="keyword">the</span> comment <span class="keyword">is</span> aligned:
[  <span class="comment">--enable-hello           Enable hello support]) </span>
</code></pre><h2 id="三">三</h2><p>编译</p>
<pre><code><span class="regexp">/usr/</span>local<span class="regexp">/php/</span>bin/phpize 
.<span class="regexp">/configure --with-php-config=/</span>usr<span class="regexp">/local/</span>php<span class="regexp">/bin/</span>php-config
make
</code></pre><p>在php.ini里添加hello.so</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/06/23/udp-flood/" itemprop="url">
                udp flood 攻击防御总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-06-23T22:51:44+08:00" content="2015-06-23">
            2015-06-23
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>[TOC]</p>
<hr>
<h2 id="分析日志">分析日志</h2><p>今天睡完觉起来、发现服务器被阿里云关停了，由于被DDos攻击，造成机房不稳定，拒绝手工解除。等待2.5小时之后自动解除。</p>
<p>查看阿里云被攻击日志，日志是.cap格式的，正常抓包生成的格式，可以用Wireshark打开，</p>
<p><img src="http://ww2.sinaimg.cn/large/005ItG0Rjw1etefgu2jh8j31ke0ion4y.jpg" alt=""></p>
<p>一看全是NTP UDP流量攻击</p>
<blockquote>
<p>无论是基于 DNS 还是基于 NTP，其最终都是基于 UDP 协议的。在 UDP 协议中正常情况下客户端发送请求包到服务端，服务端返回响应包到客户端，但是 UDP 协议是面向无连接的，所以客户端发送请求包的源 IP 很容易进行伪造，当把源 IP 修改为受害者的 IP，最终服务端返回的响应包就会返回到受害者的 IP。这就形成了一次反射攻击。</p>
</blockquote>
<p>详细介绍请看：<a href="http://drops.wooyun.org/papers/926" target="_blank" rel="external">http://drops.wooyun.org/papers/926</a></p>
<h2 id="解决方式">解决方式</h2><p>这种情况可以考虑封禁IP，不过IP实在是是太多了，而且攻击已经过去了。</p>
<p>网上找了很多解决方式，可少国内对于这方面的解决办法少得可怜。</p>
<p>1，关闭现在 NTP 服务的 monlist 功能，在ntp.conf配置文件中增加<code>disable monitor</code>选项</p>
<p>配置文件一般在<code>/etc/ntp.conf</code> 添加<code>disable monitor</code><br>重启<code>service ntpd restart</code></p>
<p>2，</p>
<p>最后还是使用比较暴力的方法：直接禁止UDP 进出口</p>
<p>参考：<a href="http://www.myhack58.com/Article/60/sort096/2012/33087.htm" target="_blank" rel="external">http://www.myhack58.com/Article/60/sort096/2012/33087.htm</a></p>
<p>iptables防火墙就不多介绍了，写完命令之后，</p>
<p>命令：</p>
<pre><code>iptables -A OUTPUT -<span class="tag">p</span> udp -j DROP
iptables -A INPUT -<span class="tag">p</span> udp -j DROP
</code></pre><p>由于这台服务器不做DNS解析，所以不用开启udp的53端口。</p>
<p>先</p>
<pre><code>/etc/rc.<span class="keyword">d</span>/init.<span class="keyword">d</span>/iptables <span class="keyword">save</span>
</code></pre><p>再</p>
<pre><code><span class="keyword">service</span> iptables <span class="literal">restart</span>
</code></pre><p>查看：<code>iptables -L -n</code></p>
<p><img src="http://ww3.sinaimg.cn/large/005ItG0Rjw1etefgte7luj30no0ai420.jpg" alt=""></p>
<hr>
<p>忽然感觉、弄台服务器都不能睡好觉了~</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/06/03/google-adsense/" itemprop="url">
                谷歌联盟Google AdSense使用总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-06-03T23:35:20+08:00" content="2015-06-03">
            2015-06-03
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>[TOC]</p>
<hr>
<p>说起来实在惭愧、历时一年终于把Google AdSense的美金收到银行卡了。总结一下谷歌联盟的艰辛赚钱路程。或许以后使用Google AdSense的人会越来越少。对于google联盟的优缺点就不说了，google不用交税，但广告样式、物料单一。</p>
<h2 id="申请Google_AdSense">申请Google AdSense</h2><p>申请的时候信息（地址、姓名）一定要填仔细了，以后不能更改了！！</p>
<p>地址英文：用拼音即可、或者用百度翻译<br>姓名英文：比如<code>赵子龙</code>，英文<code>Zilong Zhao</code></p>
<p>申请很多次不通过很正常，网站Alex排名50万都容易驳回。多申请几次就好了，一定要多申请。</p>
<h2 id="广告投放">广告投放</h2><p>注意广告投放不同的广告类型有不同的数量限制、具体参考官方说明。</p>
<p>关于单价：2014年的时候大概0.06-0.08美元;2015年降低了不少，有的时候才0.03美元。</p>
<p>目前国内中文网站的点击单价越来越低。相比国外网站的单价来讲低很多。</p>
<h2 id="验证PIN">验证PIN</h2><p>账户收入达$100之后，会提示你去发Google PIN</p>
<p>发的地址就是你申请时候填写的地址；我之前想改地址，没成功。</p>
<p>Pin历时大半年，收了3次，也没有收到。正好2015年年初爆出，邮政把国际平邮当垃圾处理了。心寒~</p>
<p>收不到Pin不会google是给你付款。</p>
<p>当我看到taobao上各种“秒过PIN”的时候，一直觉得不靠谱。</p>
<p>不过后来尝试通过google adsense 在线表单提交验证PIN地址。我直接把学生证照了照片上去。第二天就通过了。<strong>对于没有一个客服电话的google adsense来讲，真是奇迹</strong></p>
<h2 id="设置付款方式">设置付款方式</h2><p>我选择西联汇款，几乎没有其他选择。</p>
<p>西联汇款会叫你设置收款人姓名。比如<code>赵子龙</code> ；姓：Zhao 名：Zilong</p>
<p>每月月底最后一天结算上个月的钱，满100美元，会发出西联汇款，收款人就是<code>Zilong Zhao</code></p>
<p><img src="http://img.my.csdn.net/uploads/201506/04/1433347841_3311.png" alt=""></p>
<h2 id="收取西联汇款">收取西联汇款</h2><p>开始用邮政的网银收取西联汇款，提示“户名校验失败”，给邮政打电话，ta叫我给西联打电话。而且西联的只能用座机打，难道我还要去买个座机？</p>
<p>第二天（今天）直接去<strong>光大银行</strong>办了银行卡，开通网银即可。立马把钱提出来了,相当方便。使用教程请百度：《光大银行 西联汇款》</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/16/dedecms-qiniu/" itemprop="url">
                织梦dedecms 整合七牛云存储
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-05-16T14:47:36+08:00" content="2015-05-16">
            2015-05-16
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>当网站静态文件太多的时候，是时候该把静态文件换qiniu了，毕竟速度很不错，阿里云的带宽也比较昂贵，还可以减少服务器nginx的请求</p>
<h2 id="七牛配置">七牛配置</h2><p>申请一个空间、配置自己的自定义域名（高级设置里面）<br>七牛默认给你分配的是<code>7x.ajjah.qiniucdn.com</code>这种域名，由于图片url需要入库，不建议使用这种方式，可以自己cname 域名到 qiniu。配置自己的域名，防止以后迁移带来的麻烦。 </p>
<h2 id="织梦整合">织梦整合</h2><p>这里需要我们换编辑器了，利用百度编辑器ueditor二次开发</p>
<p>下载地址（含使用教程）：<a href="https://github.com/widuu/qiniu_ueditor_1.4.3" target="_blank" rel="external">https://github.com/widuu/qiniu_ueditor_1.4.3</a></p>
<h3 id="ueditor修改">ueditor修改</h3><h4 id="织梦默认分页修改">织梦默认分页修改</h4><p>修改<code>ueditor/ueditor.config.js</code></p>
<p>修改<code>include/inc/inc_fun_funAdmin.php</code><br>找到<code>//,pageBreakTag:&#39;_ueditor_page_break_tag_&#39;</code><br>改为<code>,pageBreakTag:&#39;#p#副标题#e#&#39;</code> <strong>注意：有个逗号！！！！</strong></p>
<h3 id="配置信息修改">配置信息修改</h3><p><code>include/ueditor/php/conf.php</code> 配置你的七牛信息</p>
<h3 id="织梦编辑器替换">织梦编辑器替换</h3><p>下载编辑器，按自己的要求修改之后，文件夹改名为ueditor ，复制到 <code>include</code>目录</p>
<p>打开<code>/include/inc/inc_fun_funAdmin.php</code><br>找到编辑器判断的if语句结尾，大概227行，加入</p>
<pre><code><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$GLOBALS</span>[<span class="string">'cfg_html_editor'</span>]==<span class="string">'ueditor'</span>) 
{ 
    <span class="variable">$fvalue</span> = <span class="variable">$fvalue</span>==<span class="string">''</span> ? <span class="string">'&lt;p&gt;&lt;/p&gt;'</span> : <span class="variable">$fvalue</span>; 
    <span class="variable">$code</span> = <span class="string">'&lt;script type="text/javascript" charset="utf-8" src="'</span>.<span class="variable">$GLOBALS</span>[<span class="string">'cfg_cmspath'</span>].<span class="string">'/include/ueditor/ueditor.config.js"&gt;&lt;/script&gt; 
    &lt;script type="text/javascript" charset="utf-8" src="'</span>.<span class="variable">$GLOBALS</span>[<span class="string">'cfg_cmspath'</span>].<span class="string">'/include/ueditor/ueditor.all.min.js"&gt;&lt;/script&gt; 
    &lt;link rel="stylesheet" type="text/css" href="'</span>.<span class="variable">$GLOBALS</span>[<span class="string">'cfg_cmspath'</span>].<span class="string">'/include/ueditor/themes/default/css/ueditor.css"/&gt; 
    &lt;textarea name="'</span>.<span class="variable">$fname</span>.<span class="string">'" id="'</span>.<span class="variable">$fname</span>.<span class="string">'" style="width:100%;height:500px;"&gt;'</span>.<span class="variable">$fvalue</span>.<span class="string">'&lt;/textarea&gt; 
    &lt;script type="text/javascript"&gt;var ue = new baidu.editor.ui.Editor();ue.render("'</span>.<span class="variable">$fname</span>.<span class="string">'");&lt;/script&gt;'</span>; 
    <span class="keyword">if</span>(<span class="variable">$gtype</span>==<span class="string">"print"</span>) 
    { 
        <span class="built_in">echo</span> <span class="variable">$code</span>; 
    } 
    <span class="keyword">else</span> 
    { 
        <span class="built_in">return</span> <span class="variable">$code</span>; 
    } 
}
</code></pre><p>修改织梦后台”基本参数&gt;&gt;核心设置&gt;&gt;Html编辑器”</p>
<p>完成~~~~</p>
<h3 id="织梦关闭下载远程图片">织梦关闭下载远程图片</h3><p>由于我们吧资源放到七牛，图片的url 成这个样子：<br><code>http://aaa.qiniu.com/777799.png</code><br><code>http://img.****.com/777799.png</code></p>
<p>织梦提交文档的时候，会把这些文档再一次本地化。</p>
<p><strong>解决方案1：</strong><br>后台直接关闭【下载远程图片】此功能</p>
<p><strong>解决办法2：</strong></p>
<p>修改判断远程图片下载方法<br>找到<code>dede/inc/inc_archives_function.php</code>里面<br><code>function GetCurContent</code><br>把这个<code>$basehost = &quot;http://&quot;.$_SERVER[&quot;HTTP_HOST&quot;];</code><br>直接修改为你的主域名<code>$basehost = &#39;baidu.com&#39;;</code>这样，就不会把该主域名的图片本地化</p>
<p>或者写个正则（添加以下代码），输出主域名：</p>
<pre><code>preg_match('/[<span class="link_label">\w</span>][<span class="link_reference">\w-</span>]*\.(?:com|cn|net)(\/|$)/isU', $basehost, $domain);
$basehost = rtrim($domain[0], '/');
</code></pre><h3 id="织梦旧资源同步到七牛">织梦旧资源同步到七牛</h3><p>现在在编辑器中可以吧图片上传到七牛，对于以前存在自己服务器上的图片，也可以同步七牛上，再替换数据库表<code>dede_addonarticle</code>中body字段</p>
<p>首先上七牛下载同步工具：<a href="http://developer.qiniu.com/docs/v6/tools/qrsync.html" target="_blank" rel="external">http://developer.qiniu.com/docs/v6/tools/qrsync.html</a></p>
<p>按说明很简单的配置，直接在linux主机上运行就ok了</p>
<p>同步上去之后，替换数据库</p>
<pre><code><span class="label">$mysql</span> -<span class="keyword">u</span> root -p
$输入密码
<span class="label">$use</span> 数据库名称;
mysql&gt;<span class="keyword">update</span> dede_addonarticle <span class="keyword">set</span> body =<span class="keyword">REPLACE</span>(body,'src=<span class="string">"/uploads/allimg','src="</span>http:<span class="comment">//qinniu.qiniu.com/uploads/allimg');</span>
<span class="comment">//用后者的字符串，替换前者。可以使用 where =</span>
</code></pre><p>生成全部文档~OK</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/12/limit-zone-limie-req-zone/" itemprop="url">
                nginx限制连接模块limit_zone、limie_req_zone测试
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-05-12T21:05:58+08:00" content="2015-05-12">
            2015-05-12
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>nginx默认提供的两个限制链接模块（可以用来防止简单地cc攻击）</p>
<h2 id="区别">区别</h2><p><strong>limit_zone：</strong></p>
<blockquote>
<p>limit_zone 功能是限制一个客户端的并发连接数</p>
</blockquote>
<p><strong>limie_req_zone:</strong></p>
<blockquote>
<p>lit_req_zone的功能是通过 令牌桶原理来限制 用户的连接频率，可以用来设置单个ip访问请求链接数</p>
</blockquote>
<h2 id="配置">配置</h2><p>两个可以一起用，也可以单独使用</p>
<p><strong>http配置：</strong></p>
<pre><code><span class="built_in">limit</span>_conn_zone   <span class="variable">$binary_remote_addr</span>  zone=myzone_<span class="built_in">test</span>:<span class="number">10</span>m;
<span class="built_in">limit</span>_req_zone <span class="variable">$binary_remote_addr</span> zone=<span class="built_in">test</span>:<span class="number">10</span>m rate=<span class="number">1</span>r/s;
</code></pre><p><strong>注：</strong>myzone_test 与 test 都是自定义名称，与下列配置对应</p>
<p><strong>server配置：</strong></p>
<pre><code><span class="built_in">limit</span>_conn   myzone_<span class="built_in">test</span>  <span class="number">3</span>;
<span class="comment">#同一个IP只许建立3个连接</span>
<span class="built_in">limit</span>_req zone=<span class="built_in">test</span> burst=<span class="number">120</span> nodelay;
<span class="comment">#每秒请求120个，超过返回503</span>
</code></pre><p>以上是nginx新版本1.2以后吧，1.2以前的版本http模块略有不同</p>
<pre><code><span class="built_in">limit</span>_zone   myzone_<span class="built_in">test</span>  <span class="variable">$binary_remote_addr</span>  <span class="number">10</span>m;
</code></pre><h2 id="测试">测试</h2><p>测试环境：本地mac apache2.3（ab压测）<br><img src="./1431432452780.png" alt="Alt text"></p>
<p>服务器：阿里云centos乞丐配置、nginx/1.4.4  、php5.4</p>
<p>两个一起设置：</p>
<p>http配置：</p>
<pre><code><span class="built_in">limit</span>_conn_zone   <span class="variable">$binary_remote_addr</span>  zone=myzone_<span class="built_in">test</span>:<span class="number">10</span>m;
<span class="built_in">limit</span>_req_zone <span class="variable">$binary_remote_addr</span> zone=<span class="built_in">test</span>:<span class="number">10</span>m rate=<span class="number">1</span>r/s;
</code></pre><p>server配置：</p>
<pre><code><span class="built_in">limit</span>_conn   myzone_<span class="built_in">test</span>  <span class="number">3</span>;
<span class="comment">#同一个IP只许建立3个连接</span>
<span class="built_in">limit</span>_req zone=<span class="built_in">test</span> burst=<span class="number">120</span> nodelay;
<span class="comment">#每秒请求120个，超过返回503</span>
</code></pre><p>ab压测：</p>
<pre><code>ab -c 100 -n 100 http://<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>:8088/login
</code></pre><p>nginx日志：<br><img src="http://ww2.sinaimg.cn/bmiddle/005ItG0Rjw1es1qc9qoizj31060kmwq5.jpg" alt=""></p>
<hr>
<p>ab压测：</p>
<pre><code>ab -c 3 -n 1000 http://<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>:8088/login
<span class="comment">#每秒3并发，日志全部返回200</span>
</code></pre><hr>
<p>ab压测：</p>
<pre><code>ab -c 5 -n 1000 -t 20 http://<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>:8088/login
<span class="comment">#每秒5并发，压20s，大部分返回200</span>
</code></pre><h2 id="建议">建议</h2><p>个人建议，两个模块一起用，</p>
<p>limit_zone模块用来限制并发，放在server全局。</p>
<p>limie_req_zone模块用来限制<strong>PHP的请求次数</strong></p>
<p>也就是说，limie_req_zone模块的配置放在</p>
<pre><code><span class="title">location</span> <span class="regexp">~ .*.(php|php5)$</span>
{
    <span class="title">limit_req</span> zone=test burst=<span class="number">10</span> nodelay;
}
<span class="comment">#此时burst的值应该设置小值</span>
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/01/php-redis/" itemprop="url">
                mac下php redis 初体验
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-05-01T02:06:36+08:00" content="2015-05-01">
            2015-05-01
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="mac下php_redis_初体验">mac下php redis 初体验</h2><h3 id="redis_php-redis安装">redis php-redis安装</h3><h4 id="redis安装">redis安装</h4><p>redis2.6 (已经不推荐使用了，不过我还是试了一下)</p>
<p>下载redis2.6<br>解压、安装</p>
<pre><code>tar zxf redis-<span class="number">2.6</span>.<span class="number">14</span><span class="class">.tar</span><span class="class">.gz</span>
cd redis-<span class="number">2.6</span>.<span class="number">14</span>
make &amp;&amp; make install
</code></pre><p>复制配置文件</p>
<pre><code>sudo cp ~<span class="regexp">/redis-2.6.14/</span>redis.conf <span class="regexp">/etc/</span>
</code></pre><p>启动redis 服务</p>
<pre><code><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>redis-server <span class="regexp">/etc/</span>redis.conf
</code></pre><p>连接redis</p>
<pre><code>redis-<span class="keyword">cli</span> -<span class="keyword">h</span> 127.0.0.1 -p 6379
&gt;就可以做<span class="keyword">set</span> name 简单的操作了
</code></pre><h4 id="php_redis扩展安装">php redis扩展安装</h4><p>下载地址，使用说明 <a href="https://github.com/phpredis/phpredis" target="_blank" rel="external">https://github.com/phpredis/phpredis</a></p>
<pre><code>unzip phpredis-develop.zip 
cd phpredis-develop
<span class="regexp">/usr/</span>local<span class="regexp">/php/</span>bin/phpize
.<span class="regexp">/configure --with-php-config=/</span>usr<span class="regexp">/local/</span>php<span class="regexp">/bin/</span>php-config
make &amp;&amp; make install
</code></pre><p>安装成功标志：<br><code>Installing shared extensions:     /usr/local/php/lib/php/extensions/no-debug-zts-20131226/</code></p>
<p>在php.ini里面，引入扩展redis.so</p>
<p>extension = redis.so<br>[前提是指定了extension_dir]</p>
<p>成功标志: 运行 <code>php -m | grep redis</code>就能看见redis</p>
<h3 id="redis-conf_配置文件">redis.conf 配置文件</h3><pre><code><span class="preprocessor">#是否允许后台运行，一般改为yes</span>
daemonize: yes
<span class="preprocessor">#可用数据库数，默认值为16，默认数据库为0</span>
databases <span class="number">16</span>
<span class="preprocessor">#保存数据到disk的策略</span>
<span class="preprocessor">#当有一条Keys数据被改变是，900秒刷新到disk一次</span>
save <span class="number">900</span> <span class="number">1</span>
<span class="preprocessor">#当有10条Keys数据被改变时，300秒刷新到disk一次</span>
save <span class="number">300</span> <span class="number">10</span>
<span class="preprocessor">#当有1w条keys数据被改变时，60秒刷新到disk一次</span>
save <span class="number">60</span> <span class="number">10000</span>
<span class="preprocessor">#当dump .rdb数据库的时候是否压缩数据对象</span>
rdbcompression yes
<span class="preprocessor">#本地数据库文件名，默认值为dump.rdb</span>
dbfilename dump.rdb
<span class="preprocessor">#本地数据库存放路径,默认值为 ./</span>
dir ./
</code></pre><h3 id="php使用redis">php使用redis</h3><p>手册<a href="http://www.cnblogs.com/ikodota/archive/2012/03/05/php_redis_cn.html" target="_blank" rel="external">http://www.cnblogs.com/ikodota/archive/2012/03/05/php_redis_cn.html</a></p>
<p>例子：</p>
<pre><code><span class="variable">$redis</span> <span class="subst">=</span> <span class="literal">new</span> Redis();
<span class="variable">$redis</span><span class="subst">-&gt;</span>connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);
<span class="variable">$name</span> <span class="subst">=</span> <span class="variable">$redis</span><span class="subst">-&gt;</span>get(<span class="string">'name'</span>);
var_dump(<span class="variable">$name</span>);
</code></pre><h4 id="redis升级">redis升级</h4><p>上官网下载redis-3.0.0</p>
<pre><code>tar zxf redis-<span class="number">3.0</span>.<span class="number">0</span>.tar.gz
cd redis-<span class="number">3.0</span>.<span class="number">0</span>
make
<span class="comment">//编译之后直接copy 5个程序到/usr/local/bin/ 覆盖以前的5个redis-* 程序</span>
<span class="comment">//注意不要吧.c .o 这个也复制过去</span>
cp .<span class="regexp">/src/</span>redis-* <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>
</code></pre></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a>
  </nav>


            </div>

            

            
        </div>

        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="http://my.csdn.net/uploads/avatar/B/7/1/1_yidiandianlan.jpg" alt="yidiandianlan" itemprop="image"/>
          <p class="site-author-name" itemprop="name">yidiandianlan</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">19</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">20</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yidiandianlan" target="_blank">github</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yidiandianlan</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



        </div>
    </footer>

    <div class="back-to-top"></div>
</div>

<script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
  
  

  



  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.4"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.4"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.4" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>



<script type="text/javascript">
    $(document).ready(function () {
        if (CONFIG.sidebar === 'always') {
            displaySidebar();
        }
    });
</script>




  
  

  







<!-- lazyload -->
<script type="text/javascript" src="/js/lazyload.js"></script>
<script type="text/javascript">
    jQuery(function () {
        jQuery("#posts img").lazyload({
            placeholder: "/images/loading.gif",
            effect: "fadeIn"
        });
    });
</script>
</body>
</html>
