<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>helonghua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="helonghua">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="helonghua">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="helonghua">
<meta name="twitter:description">
  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="undefined" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">yidiandianlan</a></h1>
		</hgroup>

		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">yidiandianlan</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="undefined" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">yidiandianlan</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-dedecms-qiniu" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/16/dedecms-qiniu/" class="article-date">
  	<time datetime="2015-05-16T06:47:36.000Z" itemprop="datePublished">2015-05-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/16/dedecms-qiniu/">织梦dedecms 整合七牛云存储</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>当网站静态文件太多的时候，是时候该把静态文件换qiniu了，毕竟速度很不错，阿里云的带宽也比较昂贵，还可以减少服务器nginx的请求</p>
<h2 id="七牛配置">七牛配置</h2><p>申请一个空间、配置自己的自定义域名（高级设置里面）<br>七牛默认给你分配的是<code>7x.ajjah.qiniucdn.com</code>这种域名，由于图片url需要入库，不建议使用这种方式，可以自己cname 域名到 qiniu。配置自己的域名，防止以后迁移带来的麻烦。 </p>
<h2 id="织梦整合">织梦整合</h2><p>这里需要我们换编辑器了，利用百度编辑器ueditor二次开发</p>
<p>下载地址（含使用教程）：<a href="https://github.com/widuu/qiniu_ueditor_1.4.3" target="_blank" rel="external">https://github.com/widuu/qiniu_ueditor_1.4.3</a></p>
<h3 id="ueditor修改">ueditor修改</h3><h4 id="织梦默认分页修改">织梦默认分页修改</h4><p>修改<code>ueditor/ueditor.config.js</code></p>
<p>修改<code>include/inc/inc_fun_funAdmin.php</code><br>找到<code>//,pageBreakTag:&#39;_ueditor_page_break_tag_&#39;</code><br>改为<code>,pageBreakTag:&#39;#p#副标题#e#&#39;</code> <strong>注意：有个逗号！！！！</strong></p>
<h3 id="配置信息修改">配置信息修改</h3><p><code>include/ueditor/php/conf.php</code> 配置你的七牛信息</p>
<h3 id="织梦编辑器替换">织梦编辑器替换</h3><p>下载编辑器，按自己的要求修改之后，文件夹改名为ueditor ，复制到 <code>include</code>目录</p>
<p>打开<code>/include/inc/inc_fun_funAdmin.php</code><br>找到编辑器判断的if语句结尾，大概227行，加入</p>
<pre><code><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$GLOBALS</span>[<span class="string">'cfg_html_editor'</span>]==<span class="string">'ueditor'</span>) 
{ 
    <span class="variable">$fvalue</span> = <span class="variable">$fvalue</span>==<span class="string">''</span> ? <span class="string">'&lt;p&gt;&lt;/p&gt;'</span> : <span class="variable">$fvalue</span>; 
    <span class="variable">$code</span> = <span class="string">'&lt;script type="text/javascript" charset="utf-8" src="'</span>.<span class="variable">$GLOBALS</span>[<span class="string">'cfg_cmspath'</span>].<span class="string">'/include/ueditor/ueditor.config.js"&gt;&lt;/script&gt; 
    &lt;script type="text/javascript" charset="utf-8" src="'</span>.<span class="variable">$GLOBALS</span>[<span class="string">'cfg_cmspath'</span>].<span class="string">'/include/ueditor/ueditor.all.min.js"&gt;&lt;/script&gt; 
    &lt;link rel="stylesheet" type="text/css" href="'</span>.<span class="variable">$GLOBALS</span>[<span class="string">'cfg_cmspath'</span>].<span class="string">'/include/ueditor/themes/default/css/ueditor.css"/&gt; 
    &lt;textarea name="'</span>.<span class="variable">$fname</span>.<span class="string">'" id="'</span>.<span class="variable">$fname</span>.<span class="string">'" style="width:100%;height:500px;"&gt;'</span>.<span class="variable">$fvalue</span>.<span class="string">'&lt;/textarea&gt; 
    &lt;script type="text/javascript"&gt;var ue = new baidu.editor.ui.Editor();ue.render("'</span>.<span class="variable">$fname</span>.<span class="string">'");&lt;/script&gt;'</span>; 
    <span class="keyword">if</span>(<span class="variable">$gtype</span>==<span class="string">"print"</span>) 
    { 
        <span class="built_in">echo</span> <span class="variable">$code</span>; 
    } 
    <span class="keyword">else</span> 
    { 
        <span class="built_in">return</span> <span class="variable">$code</span>; 
    } 
}
</code></pre><p>修改织梦后台”基本参数&gt;&gt;核心设置&gt;&gt;Html编辑器”</p>
<p>完成~~~~</p>
<h3 id="织梦关闭下载远程图片">织梦关闭下载远程图片</h3><p>由于我们吧资源放到七牛，图片的url 成这个样子：<br><code>http://aaa.qiniu.com/777799.png</code><br><code>http://img.****.com/777799.png</code></p>
<p>织梦提交文档的时候，会把这些文档再一次本地化。</p>
<p><strong>解决方案1：</strong><br>后台直接关闭【下载远程图片】此功能</p>
<p><strong>解决办法2：</strong></p>
<p>修改判断远程图片下载方法<br>找到<code>dede/inc/inc_archives_function.php</code>里面<br><code>function GetCurContent</code><br>把这个<code>$basehost = &quot;http://&quot;.$_SERVER[&quot;HTTP_HOST&quot;];</code><br>直接修改为你的主域名<code>$basehost = &#39;baidu.com&#39;;</code>这样，就不会把该主域名的图片本地化</p>
<p>或者写个正则（添加以下代码），输出主域名：</p>
<pre><code>preg_match('/[<span class="link_label">\w</span>][<span class="link_reference">\w-</span>]*\.(?:com|cn|net)(\/|$)/isU', $basehost, $domain);
$basehost = rtrim($domain[0], '/');
</code></pre><h3 id="织梦旧资源同步到七牛">织梦旧资源同步到七牛</h3><p>现在在编辑器中可以吧图片上传到七牛，对于以前存在自己服务器上的图片，也可以同步七牛上，再替换数据库表<code>dede_addonarticle</code>中body字段</p>
<p>首先上七牛下载同步工具：<a href="http://developer.qiniu.com/docs/v6/tools/qrsync.html" target="_blank" rel="external">http://developer.qiniu.com/docs/v6/tools/qrsync.html</a></p>
<p>按说明很简单的配置，直接在linux主机上运行就ok了</p>
<p>同步上去之后，替换数据库</p>
<pre><code><span class="label">$mysql</span> -<span class="keyword">u</span> root -p
$输入密码
<span class="label">$use</span> 数据库名称;
mysql&gt;<span class="keyword">update</span> dede_addonarticle <span class="keyword">set</span> body =<span class="keyword">REPLACE</span>(body,'src=<span class="string">"/uploads/allimg','src="</span>http:<span class="comment">//qinniu.qiniu.com/uploads/allimg');</span>
<span class="comment">//用后者的字符串，替换前者。可以使用 where =</span>
</code></pre><p>生成全部文档~OK</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dedecms/">dedecms</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/织梦/">织梦</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-limit-zone-limie-req-zone" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/12/limit-zone-limie-req-zone/" class="article-date">
  	<time datetime="2015-05-12T13:05:58.000Z" itemprop="datePublished">2015-05-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/12/limit-zone-limie-req-zone/">nginx限制连接模块limit_zone、limie_req_zone测试</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>nginx默认提供的两个限制链接模块（可以用来防止简单地cc攻击）</p>
<h2 id="区别">区别</h2><p><strong>limit_zone：</strong></p>
<blockquote>
<p>limit_zone 功能是限制一个客户端的并发连接数</p>
</blockquote>
<p><strong>limie_req_zone:</strong></p>
<blockquote>
<p>lit_req_zone的功能是通过 令牌桶原理来限制 用户的连接频率，可以用来设置单个ip访问请求链接数</p>
</blockquote>
<h2 id="配置">配置</h2><p>两个可以一起用，也可以单独使用</p>
<p><strong>http配置：</strong></p>
<pre><code><span class="built_in">limit</span>_conn_zone   <span class="variable">$binary_remote_addr</span>  zone=myzone_<span class="built_in">test</span>:<span class="number">10</span>m;
<span class="built_in">limit</span>_req_zone <span class="variable">$binary_remote_addr</span> zone=<span class="built_in">test</span>:<span class="number">10</span>m rate=<span class="number">1</span>r/s;
</code></pre><p><strong>注：</strong>myzone_test 与 test 都是自定义名称，与下列配置对应</p>
<p><strong>server配置：</strong></p>
<pre><code><span class="built_in">limit</span>_conn   myzone_<span class="built_in">test</span>  <span class="number">3</span>;
<span class="comment">#同一个IP只许建立3个连接</span>
<span class="built_in">limit</span>_req zone=<span class="built_in">test</span> burst=<span class="number">120</span> nodelay;
<span class="comment">#每秒请求120个，超过返回503</span>
</code></pre><p>以上是nginx新版本1.2以后吧，1.2以前的版本http模块略有不同</p>
<pre><code><span class="built_in">limit</span>_zone   myzone_<span class="built_in">test</span>  <span class="variable">$binary_remote_addr</span>  <span class="number">10</span>m;
</code></pre><h2 id="测试">测试</h2><p>测试环境：本地mac apache2.3（ab压测）<br><img src="./1431432452780.png" alt="Alt text"></p>
<p>服务器：阿里云centos乞丐配置、nginx/1.4.4  、php5.4</p>
<p>两个一起设置：</p>
<p>http配置：</p>
<pre><code><span class="built_in">limit</span>_conn_zone   <span class="variable">$binary_remote_addr</span>  zone=myzone_<span class="built_in">test</span>:<span class="number">10</span>m;
<span class="built_in">limit</span>_req_zone <span class="variable">$binary_remote_addr</span> zone=<span class="built_in">test</span>:<span class="number">10</span>m rate=<span class="number">1</span>r/s;
</code></pre><p>server配置：</p>
<pre><code><span class="built_in">limit</span>_conn   myzone_<span class="built_in">test</span>  <span class="number">3</span>;
<span class="comment">#同一个IP只许建立3个连接</span>
<span class="built_in">limit</span>_req zone=<span class="built_in">test</span> burst=<span class="number">120</span> nodelay;
<span class="comment">#每秒请求120个，超过返回503</span>
</code></pre><p>ab压测：</p>
<pre><code>ab -c 100 -n 100 http://<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>:8088/login
</code></pre><p>nginx日志：<br><img src="http://ww2.sinaimg.cn/bmiddle/005ItG0Rjw1es1qc9qoizj31060kmwq5.jpg" alt=""></p>
<hr>
<p>ab压测：</p>
<pre><code>ab -c 3 -n 1000 http://<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>:8088/login
<span class="comment">#每秒3并发，日志全部返回200</span>
</code></pre><hr>
<p>ab压测：</p>
<pre><code>ab -c 5 -n 1000 -t 20 http://<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span>:8088/login
<span class="comment">#每秒5并发，压20s，大部分返回200</span>
</code></pre><h2 id="建议">建议</h2><p>个人建议，两个模块一起用，</p>
<p>limit_zone模块用来限制并发，放在server全局。</p>
<p>limie_req_zone模块用来限制<strong>PHP的请求次数</strong></p>
<p>也就是说，limie_req_zone模块的配置放在</p>
<pre><code><span class="title">location</span> <span class="regexp">~ .*.(php|php5)$</span>
{
    <span class="title">limit_req</span> zone=test burst=<span class="number">10</span> nodelay;
}
<span class="comment">#此时burst的值应该设置小值</span>
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-php-redis" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/01/php-redis/" class="article-date">
  	<time datetime="2015-04-30T18:06:36.000Z" itemprop="datePublished">2015-05-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/01/php-redis/">mac下php redis 初体验</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="mac下php_redis_初体验">mac下php redis 初体验</h2><h3 id="redis_php-redis安装">redis php-redis安装</h3><h4 id="redis安装">redis安装</h4><p>redis2.6 (已经不推荐使用了，不过我还是试了一下)</p>
<p>下载redis2.6<br>解压、安装</p>
<pre><code>tar zxf redis-<span class="number">2.6</span>.<span class="number">14</span><span class="class">.tar</span><span class="class">.gz</span>
cd redis-<span class="number">2.6</span>.<span class="number">14</span>
make &amp;&amp; make install
</code></pre><p>复制配置文件</p>
<pre><code>sudo cp ~<span class="regexp">/redis-2.6.14/</span>redis.conf <span class="regexp">/etc/</span>
</code></pre><p>启动redis 服务</p>
<pre><code><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>redis-server <span class="regexp">/etc/</span>redis.conf
</code></pre><p>连接redis</p>
<pre><code>redis-<span class="keyword">cli</span> -<span class="keyword">h</span> 127.0.0.1 -p 6379
&gt;就可以做<span class="keyword">set</span> name 简单的操作了
</code></pre><h4 id="php_redis扩展安装">php redis扩展安装</h4><p>下载地址，使用说明 <a href="https://github.com/phpredis/phpredis" target="_blank" rel="external">https://github.com/phpredis/phpredis</a></p>
<pre><code>unzip phpredis-develop.zip 
cd phpredis-develop
<span class="regexp">/usr/</span>local<span class="regexp">/php/</span>bin/phpize
.<span class="regexp">/configure --with-php-config=/</span>usr<span class="regexp">/local/</span>php<span class="regexp">/bin/</span>php-config
make &amp;&amp; make install
</code></pre><p>安装成功标志：<br><code>Installing shared extensions:     /usr/local/php/lib/php/extensions/no-debug-zts-20131226/</code></p>
<p>在php.ini里面，引入扩展redis.so</p>
<p>extension = redis.so<br>[前提是指定了extension_dir]</p>
<p>成功标志: 运行 <code>php -m | grep redis</code>就能看见redis</p>
<h3 id="redis-conf_配置文件">redis.conf 配置文件</h3><pre><code><span class="preprocessor">#是否允许后台运行，一般改为yes</span>
daemonize: yes
<span class="preprocessor">#可用数据库数，默认值为16，默认数据库为0</span>
databases <span class="number">16</span>
<span class="preprocessor">#保存数据到disk的策略</span>
<span class="preprocessor">#当有一条Keys数据被改变是，900秒刷新到disk一次</span>
save <span class="number">900</span> <span class="number">1</span>
<span class="preprocessor">#当有10条Keys数据被改变时，300秒刷新到disk一次</span>
save <span class="number">300</span> <span class="number">10</span>
<span class="preprocessor">#当有1w条keys数据被改变时，60秒刷新到disk一次</span>
save <span class="number">60</span> <span class="number">10000</span>
<span class="preprocessor">#当dump .rdb数据库的时候是否压缩数据对象</span>
rdbcompression yes
<span class="preprocessor">#本地数据库文件名，默认值为dump.rdb</span>
dbfilename dump.rdb
<span class="preprocessor">#本地数据库存放路径,默认值为 ./</span>
dir ./
</code></pre><h3 id="php使用redis">php使用redis</h3><p>手册<a href="http://www.cnblogs.com/ikodota/archive/2012/03/05/php_redis_cn.html" target="_blank" rel="external">http://www.cnblogs.com/ikodota/archive/2012/03/05/php_redis_cn.html</a></p>
<p>例子：</p>
<pre><code><span class="variable">$redis</span> <span class="subst">=</span> <span class="literal">new</span> Redis();
<span class="variable">$redis</span><span class="subst">-&gt;</span>connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);
<span class="variable">$name</span> <span class="subst">=</span> <span class="variable">$redis</span><span class="subst">-&gt;</span>get(<span class="string">'name'</span>);
var_dump(<span class="variable">$name</span>);
</code></pre><h4 id="redis升级">redis升级</h4><p>上官网下载redis-3.0.0</p>
<pre><code>tar zxf redis-<span class="number">3.0</span>.<span class="number">0</span>.tar.gz
cd redis-<span class="number">3.0</span>.<span class="number">0</span>
make
<span class="comment">//编译之后直接copy 5个程序到/usr/local/bin/ 覆盖以前的5个redis-* 程序</span>
<span class="comment">//注意不要吧.c .o 这个也复制过去</span>
cp .<span class="regexp">/src/</span>redis-* <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-open-js-select" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/26/open-js-select/" class="article-date">
  	<time datetime="2015-04-26T14:26:26.000Z" itemprop="datePublished">2015-04-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/26/open-js-select/">js表单选择中国大学、大学专业、中国省市区三级联动</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="js表单选择中国大学、大学专业、中国省市区三级联动">js表单选择中国大学、大学专业、中国省市区三级联动</h2><p>[TOC]</p>
<p>由于做了几个教育网站，经常跟大学、专业报名、考生籍贯等信息打交道，把网站常用的中国大学js选择、大学专业js选择等资源共享。</p>
<p>github下载地址：<a href="https://github.com/yidiandianlan/openSelect/" target="_blank" rel="external">https://github.com/yidiandianlan/openSelect/</a></p>
<h3 id="json信息库">json信息库</h3><p><strong>大学信息json库</strong>：<code>universitySelect/chinaUniversityList.js</code></p>
<p>由于业务没有扩展到国际~~~目前只有中国的大学</p>
<p><strong>大学专业json库</strong>：<code>majorSelect/majorList.js</code></p>
<p>手工从51job上复制、目前只有本科专业，没有专科专业信息。</p>
<p><strong>省市区县地方信息库</strong>： <code>chinaCitySelect/chinaCityList.js</code></p>
<h3 id="jquery操作表单联动">jquery操作表单联动</h3><p>jquery操作表单联动，附带搜索功能，文件夹中各有一个<code>*Select.js</code>、都是简单的js操作，注释写的比较全。可以按照自己的要求修改</p>
<h3 id="例子">例子</h3><p>如果需要对例子中提供的模板样式修改，建议根据json信息库，重新自己写js。</p>
<p>样式都是统一的~</p>
<p><img src="http://ww1.sinaimg.cn/bmiddle/005ItG0Rjw1er918dsr1tj310q0mgahs.jpg" alt="大学"></p>
<p><img src="http://ww3.sinaimg.cn/bmiddle/005ItG0Rjw1er915yjq9fj310u0nstfq.jpg" alt="地区"></p>
<p><img src="http://ww3.sinaimg.cn/bmiddle/005ItG0Rjw1er912q3nyjj30zu0pgdna.jpg" alt="专业"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-apache-nginx-rewrite" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/23/apache-nginx-rewrite/" class="article-date">
  	<time datetime="2015-04-22T18:25:47.000Z" itemprop="datePublished">2015-04-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/23/apache-nginx-rewrite/">nginx和apache rewrite那点事</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>[toc]</p>
<p>本文适合初学者、大神需要绕道~</p>
<h2 id="apache_rewrite">apache rewrite</h2><p>说到apache rewrite 不得不说.htaccess 很多开源程序、IDE空间服务商、WDCN主机控制面板、包括CI PHP框架都建议大家使用.htaccess</p>
<h3 id="-htaccess">.htaccess</h3><p>不会写的参考这个工具：<a href="http://www.webconfs.com/url-rewriting-tool.php" target="_blank" rel="external">http://www.webconfs.com/url-rewriting-tool.php</a></p>
<p>典型的rewrite index.php</p>
<pre><code><span class="tag">&lt;IfModule rewrite_module&gt;</span>
<span class="keyword"><span class="common">RewriteEngine</span></span> <span class="literal">on</span>
<span class="keyword">RewriteBase</span> /
<span class="keyword"><span class="common">RewriteCond</span></span> <span class="number">$1</span> !^(index\.php|assets|robots\.txt|system|css|js)
<span class="keyword"><span class="common">RewriteCond</span></span> <span class="cbracket">%{REQUEST_FILENAME}</span> !-f
<span class="keyword"><span class="common">RewriteCond</span></span> <span class="cbracket">%{REQUEST_FILENAME}</span> !-d
<span class="keyword"><span class="common">RewriteRule</span></span> ^(.*)$ index.php/<span class="number">$1</span><span class="sqbracket"> [QSA,L]</span>
<span class="tag">&lt;/IfModule&gt;</span>
</code></pre><p>.htaccess建议添加<code>RewriteBase /</code> 表示当前更目录，比如一个网址<code>http://www.aaa.com/h.php</code> 不管域名是什么，我们都只匹配<code>h.php</code> ，不加/ 则代表匹配整个httpurl</p>
<blockquote>
<p>%{HTTP_HOST}表示当前访问的网址，只是指前缀部分，格式是www.xxx.com不包括“<a href="http://”和“/”" target="_blank" rel="external">http://”和“/”</a></p>
<p>%{REQUEST_URI}表示访问的相对地址，就是相对根目录的地址，就是域名/后面的成分</p>
<p>%{REQUEST_FILENAME}表示请求的文件名,通常用来匹配是不是文件夹(<code>!d</code>)、是不是文件（<code>!f</code>）</p>
</blockquote>
<p>下面说一下<code>!</code>  、 <code>^</code>和<code>$</code>  </p>
<p><code>!</code> 顾形思义表示：非<br><code>^</code> 表示：开头<br><code>$</code> 表示：结尾</p>
<p>简单的例子：</p>
<p><code>RewriteRule ^(.*)$ index.php/$1 [QSA,L]</code></p>
<p>^开头、<code>$</code>结尾 ；上面的意思是 (.<em>) 不管这里面是什么 都放到$1的位置<br>注意：<code>$</code>  和 <code>$1</code> 没一点关系<br>上面这个例子 <code>$1</code> = `(.</em>)`</p>
<p>[L] 表示最后一条，不会再往下解析了。相当于if(){}闭合了、不干活了<br>[QSA] 这个不好理解，大家加，你就加上吧</p>
<blockquote>
<p>此标记强制重写引擎在已有的替换串中追加一个请求串，而不是简单的替换。 如果需要通过重写规则在请求串中增加信息，就可以使用这个标记。</p>
</blockquote>
<p>接着说开头的例子：</p>
<p><code>RewriteCond $1 !^(index\.php|assets|robots\.txt|system|css|js)</code><br>这个家伙是用来匹配开头的，意思：不以inde.php 或者是 assets 开头的url执行下面的语句</p>
<p>如果我们要匹配结尾：<br><code>RewriteCond %{REQUEST_URI} !^.*(.css|.js|.gif|.png|.jpg|.jpeg)$</code><br>这家伙表示不以.css .js .png 结尾的url执行下面的语句<br>对于初学者<br><code>RewriteCond %{REQUEST_URI} !^(.*)(.css|.js|.gif|.png|.jpg|.jpeg)$</code> 这样更好理解<br>! 表示非<br>^表示开始啦~<br>(.*)不管什么东西<br>$结束url</p>
<h3 id="rewrite写在vhost">rewrite写在vhost</h3><p>大部分规则和.htaccess一样，只是需要注意。</p>
<p>一、<strong>strong text</strong>不能用 <code>RewriteBase /</code> 这东西表示当前目录。vhost文件又不在程序里面，所以不能用。<br>也不能用下面这个</p>
<pre><code><span class="keyword"><span class="common">RewriteCond</span></span> <span class="cbracket">%{REQUEST_FILENAME}</span> !-f
<span class="keyword"><span class="common">RewriteCond</span></span> <span class="cbracket">%{REQUEST_FILENAME}</span> !-d
</code></pre><p>已经不能用他两来判断请求的文件是不是file or dir<br>这个也是相对.htaccess路径的，在vhost里面，需要用全路径<br>需要这么写：</p>
<pre><code><span class="keyword"><span class="common">RewriteCond</span></span> <span class="cbracket">%{DOCUMENT_ROOT}</span><span class="cbracket">%{REQUEST_FILENAME}</span> !-f
<span class="keyword"><span class="common">RewriteCond</span></span> <span class="cbracket">%{DOCUMENT_ROOT}</span><span class="cbracket">%{REQUEST_FILENAME}</span> !-d
</code></pre><p><strong>二、</strong>index.php 过滤</p>
<p>.htaccess ：<code>RewriteRule ^(.*)$ index.php/$1 [QSA,L]</code><br>vhost : <code>RewriteRule ^/(.*)$ /index.php/$1 [QSA,L]</code><br>仔细对比，vhost多了两个<code>/</code>;这是因为在.htaccess 声明了<code>RewriteBase /</code> </p>
<p>以下是vhost简单的例子：（如果要写在.htaccess 需要将<code>RewriteRule ^/(.*)/(.*)$</code>第一个<code>/</code>去掉，因为.htaccess相对根目录）</p>
<pre><code><span class="keyword"><span class="common">RewriteRule</span></span> ^/(.*)/(.*)$ /mobile.php?action=<span class="number">$1</span>&amp;id=<span class="number">$2</span><span class="sqbracket"> [QSA,L]</span>

<span class="comment">##第一个路径为list 或者是 article</span>
<span class="keyword"><span class="common">RewriteRule</span></span> ^/(list|article)/(.*)$ /mobile.php?action=<span class="number">$1</span>&amp;id=<span class="number">$2</span><span class="sqbracket"> [QSA,L]</span>

<span class="comment">##第一个路径的第一个字符是数字</span>
<span class="keyword"><span class="common">RewriteRule</span></span> ^/(.[0-9]*)/(.*)$ /mobile.php?action=<span class="number">$1</span>&amp;id=<span class="number">$2</span><span class="sqbracket"> [QSA,L]</span>

<span class="comment">##第一个路径的全是小写字母，[a-z]+ 表示连续的[a-z],也就是小写走吗</span>
<span class="keyword"><span class="common">RewriteRule</span></span> ^/(.[a-z]+)/(.*)$ /mobile.php?action=<span class="number">$1</span>&amp;id=<span class="number">$2</span><span class="sqbracket"> [QSA,L]</span>
</code></pre><h2 id="nginx_rewrite">nginx rewrite</h2><p>说完apache 再来说说nginx、nginx 只有vhost</p>
<p>首先推荐一个工具：apache 转 nginx <strong>只支持apache的.htaccess</strong><br><a href="http://www.anilcetin.com/convert-apache-htaccess-to-nginx/" target="_blank" rel="external">http://www.anilcetin.com/convert-apache-htaccess-to-nginx/</a></p>
<p>看一下上面第一个讲的.htaccess的例子被转为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($<span class="number">1</span> !~ <span class="string">"^(index.php|assets|robots.txt|system|css|js)"</span>)&#123;</span><br><span class="line">	set <span class="variable">$rule_0</span> <span class="number">1</span><span class="variable">$rule_0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( ~ <span class="string">""</span>)&#123;</span><br><span class="line">	set <span class="variable">$rule_0</span> <span class="number">2</span><span class="variable">$rule_0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$rule_0</span> = <span class="string">"21"</span>)&#123;</span><br><span class="line">	rewrite / /;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码前面很好理解、判断条件，拼接<code>$rule_0</code><br>这个<code>rewrite / /;</code>比较难理解,意思是过滤了入口文件。这个和<code>rewrite (.*) /index.php;</code>是等价的。<br>但是如果你的入口文件不是<code>index.php</code> 就不能<code>rewrite / /;</code>些</p>
<p>nginx过滤index.php 的最简单配置</p>
<pre><code><span class="title">location</span> / {
    <span class="title">if</span> (-f <span class="variable">$request_filename</span>/index.php){
        <span class="title">rewrite</span> (.*) <span class="variable">$1</span>/index.php;
    }
    <span class="title">if</span> (!-f <span class="variable">$request_filename</span>){
        <span class="title">rewrite</span> (.*) /index.php;
    }
}
</code></pre><p>不要写这种<code>rewrite ^/(.*)$ /index.php/$1 last;</code> 按照apache的理解方式，确实是这样写的，这样会重复rewrite 成这个样子的url：<code>/index.pnp/index.php/index.php</code></p>
<p>关于上面这段代码</p>
<pre><code><span class="keyword">if</span> (-f <span class="variable">$request_filename</span>/<span class="keyword">index</span>.php){
    rewrite (.*) <span class="variable">$1</span>/<span class="keyword">index</span>.php;
}
</code></pre><p>其实如果单纯作为过滤index.php 如果你的vhost里面还配置了fastcgi<br>这一段可以不需要。<br>nginx 最开始会去正则 location 目录。如果是.php结尾。<strong>直接进入fastcgi</strong></p>
<pre><code><span class="title">location</span> <span class="regexp">~* \.(php|php5)?$</span>
{
    <span class="title">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>
}
</code></pre><p>不会进入 location / {……} 这里面；</p>
<h3 id="location">location</h3><p>nginx 重写参数这一块和apache一样</p>
<p>不过nginx判断路径的地方有挺多，不像apache只有一个RewriteCond条件</p>
<p>location基本语法：location [=|~|~<em>|^~] /uri/ { … }<br>= 严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求。<br>~ 为区分大小写匹配(可用正则表达式)<br>~</em> 为不区分大小写匹配(可用正则表达式)<br>!~和!~<em>分别为区分大小写不匹配及不区分大小写不匹配<br>^~ 如果把这个前缀用于一个常规字符串,那么告诉nginx 如果路径匹配那么不测试正则表达式。<br>Location语法语法：location [=|~|~</em>|^~] /uri/ { … }</p>
<p>注意上面的语法：只有~和~<em> 可以使用正则。其他都不行！！！但是<br>location / { <em>*这里还是可以写正则</em></em> }</p>
<p>比如我们配置list和article路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~* /(list|article)/ &#123;</span><br><span class="line">	rewrite ^/(.*)/(.*)$ /mobile.php?action=<span class="variable">$1</span>&amp;id=<span class="variable">$2</span> last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>location 优先等级</p>
<blockquote>
<p>(location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~* 正则) &gt; (location 路径) &gt; (/)</p>
</blockquote>
<p>其他配置参考（来源阿里云一键安装包）：</p>
<p><img src="./1429532117325.png" alt="Alt text"><br>图片中<code>~ . *</code>中 . 可以不要</p>
<p><strong>总结：nginx 的 rewrite 比 apache 灵活的太多<del>~</del></strong> </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/apache/">apache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-nginx-config" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/14/nginx-config/" class="article-date">
  	<time datetime="2015-04-14T07:49:37.000Z" itemprop="datePublished">2015-04-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/14/nginx-config/">nginx常用配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>[toc]</p>
<h2 id="nginx_CPU亲缘性">nginx CPU亲缘性</h2><p>nginx默认是可以利用多核CPU的，当然也可以设置CPU亲缘性（正常小服务器不建议设置），可以用<code>worker_cpu_affinity</code>配置参数来充分利用多核cpu的性能</p>
<p>通常我们把进程数<code>worker_processes</code>设置为cpu核数，当然也可以设置为cpu数量的倍数，不过这样会造成进程之间哄抢cpu资源</p>
<h3 id="worker_cpu_affinity规则">worker_cpu_affinity规则</h3><ul>
<li>cpu有多少个核，就有<strong>几位数</strong>，1代表内核开启，0代表内核关闭</li>
<li>worker_processes最多开启8个，8个以上性能就不会再提升了，而且稳定性会变的更低，因此8个进程够用了</li>
</ul>
<p>例：2核CPU，开启2个进程</p>
<pre><code><span class="title">worker_processes</span>  <span class="number">2</span>;  
<span class="title">worker_cpu_affinity</span> <span class="number">01</span> <span class="number">10</span>;
</code></pre><p>2核CPU，开启4进程</p>
<pre><code><span class="title">worker_processes</span> <span class="number">4</span>;
<span class="title">worker_cpu_affinity</span> <span class="number">01</span> <span class="number">10</span> <span class="number">01</span> <span class="number">10</span>;
</code></pre><p>2核CPU，开启8进程</p>
<pre><code><span class="title">worker_processes</span>  <span class="number">8</span>;  
<span class="title">worker_cpu_affinity</span> <span class="number">01</span> <span class="number">10</span> <span class="number">01</span> <span class="number">10</span> <span class="number">01</span> <span class="number">10</span> <span class="number">01</span> <span class="number">10</span>;
</code></pre><p>8核CPU，开启2进程</p>
<pre><code><span class="title">worker_processes</span>  <span class="number">2</span>;  
<span class="title">worker_cpu_affinity</span> <span class="number">10101010</span> <span class="number">01010101</span>;
</code></pre><p>8核CPU，开启8进程</p>
<pre><code><span class="title">worker_processes</span> <span class="number">8</span>;
<span class="title">worker_cpu_affinity</span> <span class="number">00000001</span> <span class="number">00000010</span> <span class="number">00000100</span> <span class="number">00001000</span> <span class="number">00010000</span> <span class="number">00100000</span> <span class="number">01000000</span> <span class="number">10000000</span>;
</code></pre><h2 id="nginx缓存">nginx缓存</h2><p>nginx有两种缓存机制:fastcgi_cache和proxy_cache</p>
<ul>
<li><p>proxy_cache作用是缓存后端服务器的内容，可能是任何内容，包括静态的和动态的</p>
</li>
<li><p>fastcgi_cache作用是缓存fastcgi生成的内容，很多情况是php生成的动态内容</p>
</li>
<li><p>proxy_cache缓存减少了nginx与后端通信的次数，节省了传输时间和后端带宽</p>
</li>
<li><p>fastcgi_cache缓存减少了nginx与php的通信次数，更减轻了php和数据库的压力。</p>
</li>
</ul>
<h3 id="proxy_cache">proxy_cache</h3><h4 id="http模块">http模块</h4><p>1.首先我们需要在nginx.conf  http模块设置缓存的路径与信息</p>
<pre><code><span class="comment">#cache begin</span>
<span class="title">proxy_buffering</span> <span class="built_in">on</span>;
<span class="title">proxy_cache_valid</span> any <span class="number">10m</span>;
<span class="title">proxy_cache_path</span> /data/cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=cache_one:<span class="number">100m</span> max_size=<span class="number">10g</span> inactive=<span class="number">1d</span>;
<span class="title">proxy_temp_path</span> /data/temp;
<span class="title">proxy_buffer_size</span> <span class="number">4k</span>;
<span class="title">proxy_buffers</span> <span class="number">100</span> <span class="number">8k</span>;
<span class="comment">#cache end</span>
</code></pre><p>以上配置proxy_cache_path、proxy_temp_path是必须要配置的</p>
<p><code>proxy_buffering</code>：是否开启缓存<br>语法: proxy_buffering on|off<br>默认值: proxy_buffering on<br>上下文: http, server, location</p>
<p><code>proxy_cache_valid</code>: 为不同的应答设置不同的缓存时间<br>语法：proxy_cache_valid reply_code [reply_code …] time;<br>默认值：None<br>上下文：http, server, location</p>
<p><code>proxy_cache_path</code>:缓存存放路径<br>levels：      指定缓存的子目录数 1:2表示两级目录</p>
<p>keys_zone：所有活动的key和元数据存储在共享的内存区域中 cache_one是key 100m是内存大小</p>
<p>max_size：  缓存的最大空间<br>inactive：    过期时间</p>
<p><code>proxy_temp_path</code>:缓存临时路径</p>
<p>proxy_cache_path和proxy_temp_path应该使用在相同的文件系统上。</p>
<p><code>proxy_buffer_size</code>:<br>语法: proxy_buffer_size the_size<br>默认值: proxy_buffer_size 4k/8k<br>上下文: http, server, location</p>
<p>该指令设置缓冲区大小,从代理后端服务器取得的第一部分的响应内容,会放到这里.<br>小的响应header通常位于这部分响应内容里边.<br>默认来说,该缓冲区大小等于指令 proxy_buffers所设置的;但是,你可以把它设置得更小.</p>
<p><code>proxy_buffers</code>:<br>语法: proxy_buffers the_number is_size;<br>默认值: proxy_buffers 8 4k/8k;<br>上下文: http, server, location</p>
<p>该指令设置缓冲区的大小和数量,从被代理的后端服务器取得的响应内容,会放置到这里. 默认情况下,一个缓冲区的大小等于内存页面大小,可能是4K也可能是8K,这取决于平台。</p>
<p>更多nginx buffer参考：<a href="http://blog.csdn.net/ikmb/article/details/7098080" target="_blank" rel="external">http://blog.csdn.net/ikmb/article/details/7098080</a><br>更多nginx 配置参考：<a href="http://www.jbxue.com/article/3768.html" target="_blank" rel="external">http://www.jbxue.com/article/3768.html</a></p>
<h4 id="location模块">location模块</h4><p>2.我们需要在server location 模块添加proxy_cache 配置</p>
<p><strong>注意：</strong>proxy_cache需要proxy_pass配置才能生成缓存内容<br>也就是说：proxy_cache 需要在反向代理下才能使用</p>
<blockquote>
<p>proxy_cache它是一个重定向，反向代理（proxy_pass）的缓存功能，不是根据url生成缓存静态文件的功能</p>
</blockquote>
<p>例子：</p>
<pre><code><span class="title">location</span> / {
<span class="title">proxy_pass</span> <span class="url">http://apachephp</span>;
<span class="title">proxy_cache</span> cache_one;

<span class="comment">#对不同的HTTP状态码设置不同的缓存时间</span>
<span class="title">proxy_cache_valid</span> <span class="number">200</span> <span class="number">304</span> <span class="number">12h</span>;

<span class="comment">#Proxy Settings</span>
<span class="title">proxy_redirect</span> <span class="built_in">off</span>;

<span class="comment">#以域名、URI、参数组合成Web缓存的Key值，Nginx根据Key值哈希，存储缓存内容到二级缓存目录内</span>
<span class="title">proxy_cache_key</span> <span class="variable">$host</span><span class="variable">$uri</span><span class="variable">$is_args</span><span class="variable">$args</span>;

<span class="title">proxy_set_header</span> Host <span class="variable">$host</span>;
<span class="title">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;
<span class="title">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;

<span class="comment">#如果后端的服务器返回502、504、执行超时等错误，自动将请求转发到upstream负载均衡池中的另一台服务器，实现故障转移。</span>
<span class="title">proxy_next_upstream</span> <span class="built_in">error</span> timeout invalid_header http_500 http_502 http_503 http_504;

<span class="title">proxy_max_temp_file_size</span> <span class="number">0</span>;
<span class="title">proxy_connect_timeout</span> <span class="number">90</span>;
<span class="title">proxy_send_timeout</span> <span class="number">90</span>;
<span class="title">proxy_read_timeout</span> <span class="number">90</span>;
<span class="title">proxy_buffer_size</span> <span class="number">4k</span>;
<span class="title">proxy_buffers</span> <span class="number">4</span> <span class="number">32k</span>;
<span class="title">proxy_busy_buffers_size</span> <span class="number">64k</span>;
<span class="title">proxy_temp_file_write_size</span> <span class="number">64k</span>;
<span class="comment">##End Proxy Settings</span>
}
</code></pre><p>清楚proxy_cache缓存、安装purge模块</p>
<pre><code><span class="title">location</span> <span class="regexp">~ /purge(/.*)</span>
{
 <span class="comment">#设置只允许指定的IP或IP段才可以清除URL缓存。</span>
 <span class="title">allow</span>     <span class="number">127.0.0.1</span>;
 <span class="title">allow</span>     <span class="number">192.168.0.0</span>/<span class="number">16</span>;
 <span class="title">deny</span>      all;
 <span class="title">proxy_cache_purge</span>    cache_one   <span class="variable">$host</span><span class="variable">$1</span><span class="variable">$is_args</span><span class="variable">$args</span>;
}
</code></pre><p>安装可以参考：<a href="http://weizhifeng.net/nginx-proxy-cache.html" target="_blank" rel="external">http://weizhifeng.net/nginx-proxy-cache.html</a></p>
<h3 id="fastcgi_cache">fastcgi_cache</h3><p>总体来说，fastcgi_cache和proxy_cache一样、对应的时fastcgi_pass</p>
<h4 id="http模块-1">http模块</h4><p><code>fastcgi_connect_timeout 300;</code><br>指定连接到后端FastCGI的超时时间。<br><code>fastcgi_send_timeout 300;</code><br>向FastCGI传送请求的超时时间，这个值是指已经完成两次握手后向FastCGI传送请求的超时时间。<br><code>fastcgi_read_timeout 300;</code><br>接收FastCGI应答的超时时间，这个值是指已经完成两次握手后接收FastCGI应答的超时时间。<br><code>fastcgi_buffer_size 32k;</code><br>指定读取FastCGI应答第一部分需要用多大的缓冲区，一般第一部分应答不会超过1k，由于页面大小为4k，所以这里设置为4k。</p>
<p><code>fastcgi_buffers 4 32k;</code></p>
<blockquote>
<p>定本地需要用多少和多大的缓冲区来缓冲FastCGI的应答请求。如果一个PHP脚本所产生的页面大小为256KB，那么会为其分配4个64KB的缓冲区来缓存；如果页面大小大于256KB，那么大于256KB的部分会缓存到fastcgi_temp指定的路径中，但是这并不是好方法，因为内存中的数据处理速度要快于硬盘。一般这个值应该为站点中PHP脚本所产生的页面大小的中间值，如果站点大部分脚本所产生的页面大小为256KB，那么可以把这个值设置为“16 16k”、“4 64k”等。</p>
</blockquote>
<p><code>fastcgi_busy_buffers_size 64k;</code><br>默认值是fastcgi_buffers的两倍。<br><code>fastcgi_temp_file_write_size 64k;</code><br>在写入fastcgi_temp_path时将用多大的数据块，默认值是fastcgi_buffers的两倍。</p>
<p>缓存路径（和proxy_cache_path一样）</p>
<pre><code>fastcgi_cache_path /var/logs/nginx/fastcgi_cache_dir <span class="variable">levels=</span><span class="number">1</span>:<span class="number">2</span> <span class="variable">keys_zone=</span>cache_fastcgi:<span class="number">128</span>m <span class="variable">inactive=</span><span class="number">1</span>d <span class="variable">max_size=</span><span class="number">10</span>g;
</code></pre><h4 id="location模块-1">location模块</h4><pre><code><span class="title">location</span> <span class="regexp">~ \.php$</span> {
<span class="title">root</span> /var/www/html/blog;
<span class="title">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;
<span class="title">fastcgi_index</span> index.php;
<span class="title">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;
<span class="title">include</span> fastcgi_params;
<span class="title">fastcgi_cache</span> cache_fastcgi;
<span class="comment">#表示开启FastCGI缓存并为其指定一个名称。</span>
<span class="title">fastcgi_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">301</span> <span class="number">1h</span>;
<span class="title">fastcgi_cache_valid</span> any <span class="number">1m</span>;
<span class="comment">#为指定的应答代码指定缓存时间，如上例中将200，302 301应答缓存一小时，其他为1分钟。</span>
<span class="title">fastcgi_cache_min_uses</span> <span class="number">1</span>;
<span class="comment">#设置链接请求几次就被缓存。</span>
<span class="title">fastcgi_cache_use_stale</span> <span class="built_in">error</span> timeout invalid_header http_500;
<span class="comment">#定义哪些情况下用过期缓存</span>
<span class="title">fastcgi_cache_key</span> <span class="variable">$request_method</span>://<span class="variable">$host</span><span class="variable">$request_uri</span>;
<span class="comment">#注意一定要加上$request_method作为cache key，否则如果HEAD类型的先请求会导致后面的GET请求返回为空</span>

<span class="title">fastcgi_pass_header</span> Set-Cookie;
<span class="comment">#设置缓存的过程中发现无法获取cookie，经查需要定义这句话</span>
}
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-srcElement-fromElement-toElement" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/11/srcElement-fromElement-toElement/" class="article-date">
  	<time datetime="2015-04-10T16:16:52.000Z" itemprop="datePublished">2015-04-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/11/srcElement-fromElement-toElement/">srcElement、fromElement、toElement、target、currentTarget这些都是什么</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="srcElement、fromElement、toElement、target、currentTarget这些都是什么">srcElement、fromElement、toElement、target、currentTarget这些都是什么</h4><p>作为一个javascript的新手很可能经常搞混了这几个对象</p>
<h5 id="分派系">分派系</h5><p>首先分一下派系：</p>
<table>
<thead>
<tr>
<th style="text-align:left">对象\浏览器</th>
<th style="text-align:left">FF</th>
<th style="text-align:center">Chrom</th>
<th style="text-align:center">IE678</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">srcElement</td>
<td style="text-align:left">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">fromElement</td>
<td style="text-align:left">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">toElement</td>
<td style="text-align:left">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:left">target</td>
<td style="text-align:left">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:left">currentTarget</td>
<td style="text-align:left">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
</tbody>
</table>
<h6 id="关于：srcElement、fromElement、toElement">关于：srcElement、fromElement、toElement</h6><blockquote>
<p>event.srcElement：引发事件的目标对象，常用于onclick事件。</p>
<p>event.fromElement：常用于onmouseout和onmouseover事件</p>
<p>event.toElement：常用于onmouseout和onmouseover事件</p>
<p>onmouseover时，srcElement相当于toElement<br>onmouseout时，srcElement相当于fromSrcElement</p>
</blockquote>
<h6 id="关于：srcElement_target">关于：srcElement  target</h6><p>火狐下的<code>event.target = event.srcElement</code>(IE)</p>
<p>所以我们经常看见这样的兼容代码：</p>
<pre><code><span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>{
    <span class="keyword">var</span> e=event || <span class="built_in">window</span>.event; <span class="comment">//火狐和IE的事件对象区分</span>
    <span class="keyword">var</span> srcElement = e.srcElement || e.target; 
}
</code></pre><h6 id="target_与currentTarget_以及this的区别">target 与currentTarget 以及this的区别</h6><blockquote>
<p>在事件处理程序内部，对象this始终等于currentTarget的值，而target则只包含事件的实际目标。如果直接将事件处理程序指定给了目标元素，则this、currentTarget和target包含相同的值</p>
</blockquote>
<pre><code><span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">"myBtn"</span>);
btn.onclick = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> </span>{
    alert(event.currentTarget === <span class="keyword">this</span>); <span class="comment">//ture</span>
    alert(event.target === <span class="keyword">this</span>); <span class="comment">//ture</span>
};
</code></pre><p>看一下冒泡的过程，有什么区别：</p>
<pre><code><span class="built_in">document</span>.body.onclick = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> </span>{
    alert(event.currentTarget === <span class="built_in">document</span>.body); <span class="comment">//ture</span>
    alert(<span class="keyword">this</span> === <span class="built_in">document</span>.body); <span class="comment">//ture</span>
    alert(event.target === <span class="built_in">document</span>.getElementById(<span class="string">"myBtn"</span>)); <span class="comment">//ture</span>
};
</code></pre><p>点击上面这个例子的按钮时，this和currentTarget都等于document.body，因为事件处理程序是注册到这个元素的。然而，target元素却等于按钮元素，以为它是click事件真正的目标。由于按钮上并没有注册事件处理程序，结果click事件就冒泡到了document.body，在那里事件才得到了处理。</p>
<p>所以有以下结论：</p>
<blockquote>
<p>js中target与currentTarget的区别的关键在于他们所处在的事件流的阶段是不一样的，target处于事件流的目标阶段，currentTarget处理事件流的捕获、处于目标阶段和冒泡阶段。只有当他们同事处于目标阶段的时候他们的指向才是一样的</p>
</blockquote>
<p>例子代码：试一下就明白了</p>
<pre><code><span class="doctype">&lt;!DOCTYPE HTML&gt;</span>
<span class="tag">&lt;<span class="title">html</span>&gt;</span>
<span class="tag">&lt;<span class="title">head</span>&gt;</span>
<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span> /&gt;</span>
<span class="tag">&lt;<span class="title">title</span>&gt;</span>js性能优化<span class="tag">&lt;/<span class="title">title</span>&gt;</span>
<span class="tag">&lt;/<span class="title">head</span>&gt;</span>
<span class="tag">&lt;<span class="title">body</span>&gt;</span> 
    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"outer"</span>&gt;</span>
        outer
        <span class="tag">&lt;<span class="title">p</span>&gt;</span>
            inner
        <span class="tag">&lt;/<span class="title">p</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
<span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="clojure">
<span class="list">(<span class="keyword">function</span><span class="list">()</span><span class="collection">{
    var a=document.getElementById<span class="list">(<span class="keyword">'outer'</span>)</span><span class="comment">;</span>
        a.addEventListener<span class="list">(<span class="keyword">'click'</span>,function<span class="list">(<span class="keyword">e</span>)</span><span class="collection">{
        alert<span class="list">(<span class="keyword">e.target.innerHTML</span>)</span><span class="comment">;</span>
        alert<span class="list">(<span class="keyword">e.currentTarget.innerHTML</span>)</span><span class="comment">;</span>
        alert<span class="list">(<span class="keyword">e.currentTarget</span> === e.target)</span><span class="comment">;</span>
    }</span>,<span class="literal">false</span>)</span><span class="comment">;</span>
}</span>)</span><span class="list">()</span><span class="comment">;</span>
</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;/<span class="title">html</span>&gt;</span>
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-process-understand" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/07/process-understand/" class="article-date">
  	<time datetime="2015-04-07T15:07:42.000Z" itemprop="datePublished">2015-04-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/07/process-understand/">nodejs|php|nginx|apache多进程与多线程的理解</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<h2 id="多线程与多进程概念">多线程与多进程概念</h2><p>首先要理解这两个名词的概念<br>参考博客<a href="http://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html</a></p>
<ul>
<li>进程：程序的一次执行</li>
<li>线程：CPU的基本调度单位</li>
<li>一个进程可以包括多个线程</li>
<li>单个CPU一次只能运行一个进程</li>
</ul>
<h2 id="nodejs的单线程与I/O异步">nodejs的单线程与I/O异步</h2><p>技术选型的时候，碰到I/O密集型的项目（文件、网络的读写、数据库操作、Web Service、HttpRequest以及.net Remoting等跨进程）我们会首选nodejs</p>
<p>nodejs只有一个主线程（event loop）,也只占用一个CPU内核,但是看下面这句话：</p>
<blockquote>
<p>所有阻塞的部分交给一个线程池处理，然后这个主线程通过一个队列跟线池协作，于是对我们写到的js代码部分，不再关心线程问题，代码也主要由一堆callback回调构成，然后主线程在不停的循环过程中，适时调用这些代码。<br>除了你的代码是单线程，其余都是多线程（线程池），nodejs本身是事件驱动，一个io事件完成会被放到一个事件队列中，主线程负责轮训这个队列，然后执行相应的回调函数</p>
</blockquote>
<p>当nodejs碰到CPU密集型的应用场景就有些头痛了（比如：复杂的算法,大规模图形处理）；这个时候我们或许可以fork一个子进程<code>child_process.fork()</code></p>
<p>主进程文件forkParent.js</p>
<pre><code><span class="keyword">var</span> cp = <span class="keyword">require</span>(<span class="string">'child_process'</span>);

<span class="keyword">var</span> child = cp.fork(__dirname+<span class="string">'/forkChild.js'</span>);

child.<span class="keyword">on</span>(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span><span class="params">(m)</span> <span class="comment">{
  process.stdout.write(m.result.toString());
}</span>);</span>

(<span class="function"><span class="keyword">function</span> <span class="title">fiboLoop</span> <span class="params">()</span> <span class="comment">{
  child.send({v:40}</span>);</span>
  process.nextTick(fiboLoop);
})();


(<span class="function"><span class="keyword">function</span> <span class="title">spinForever</span> <span class="params">()</span> <span class="comment">{
  process.stdout.write(".");
  process.nextTick(spinForever);
}</span>)<span class="params">()</span>;</span>
</code></pre><p>计算斐波那契数列的子进程文件forkChild.js</p>
<pre><code>function fibo (n) {
  <span class="keyword">return</span> n &gt; <span class="number">1</span> ? fibo(n - <span class="number">1</span>) + fibo(n - <span class="number">2</span>) : <span class="number">1</span>;
}

process.on('message', function(m) {
  process.send({ <span class="literal">result</span>: fibo(m.v) });
});
</code></pre><p>这样就可以利用cpu的使用率了，关于nodejs的fork：</p>
<blockquote>
<p>实际上fork()得到的并不是子进程，而是一个全新的Node.js程序实例。并且每个新实例至少需要30ms的启动时间和10M内存，也就是说通过fork()繁衍进程，不光是充分利用了CPU，也需要很多内存，所以不能fork()太多。如果你有兴趣，可以再fork()一个或几个进程，并创建跟这个（些）进程交互的函数，查看下资源占用情况。</p>
</blockquote>
<p>当然碰到大项目的时候，建议使用node官方的cluster模块进行多线程、充分利用多核CPU资源</p>
<p>本文参考网址：<a href="http://www.infoq.com/cn/articles/nodejs-weakness-cpu-intensive-tasks" target="_blank" rel="external">http://www.infoq.com/cn/articles/nodejs-weakness-cpu-intensive-tasks</a></p>
<h2 id="nginx与apache的进程与线程">nginx与apache的进程与线程</h2><h3 id="nginx多进程">nginx多进程</h3><p>其实nginx也是有多线程的，只不过一般不用，我们只用默认的多进程</p>
<h5 id="daemon守护线程">daemon守护线程</h5><p>nginx在启动后，在unix系统中会以daemon的方式在后台运行，后台进程包含一个master进程和多个worker进程。如下图：<br><img src="http://images.cnitblog.com/blog/452899/201306/18090843-02db8793402a4e1e978fe68ac75c23cf.png" alt=""></p>
<blockquote>
<p>master进程主要用来管理worker进程，包含：接收来自外界的信号，向各worker进程发送信号，监控worker进程的运行状态，当worker进程退出后(异常情况下)，会自动重新启动新的worker进程。</p>
<p>worker进程则是处理基本的网络事件。多个worker进程之间是对等的，他们同等竞争来自客户端的请求，各进程互相之间是独立的。一个请求，只可能在一个worker进程中处理，一个worker进程，不可能处理其它进程的请求。</p>
<p>worker进程的个数是可以设置的，一般我们会设置与机器cpu核数一致。更多的worker数，只会导致进程来竞争cpu资源了，从而带来不必要的上下文切换。而且，nginx为了更好的利用多核特性，具有cpu绑定选项，我们可以将某一个进程绑定在某一个核上，这样就不会因为进程的切换带来cache的失效。</p>
</blockquote>
<h5 id="惊群现象">惊群现象</h5><blockquote>
<p>每个worker进程都是从master进程fork过来。在master进程里面，先建立好需要listen的socket之后，然后再fork出多个worker进程，这样每个worker进程都可以去accept这个socket(当然不是同一个socket，只是每个进程的这个socket会监控在同一个ip地址与端口，这个在网络协议里面是允许的)。一般来说，当一个连接进来后，所有在accept在这个socket上面的进程，都会收到通知，而只有一个进程可以accept这个连接，其它的则accept失败。</p>
</blockquote>
<h5 id="相对于线程，采用进程的优点">相对于线程，采用进程的优点</h5><ul>
<li>进程之间不共享资源，不需要加锁，所以省掉了锁带来的开销。</li>
<li>采用独立的进程，可以让互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，master进程则很快重新启动新的worker进程</li>
<li><strong>编程上更加容易</strong></li>
</ul>
<h5 id="多线程的问题">多线程的问题</h5><p>多线程在多并发情况下，线程的内存占用大，线程<strong>上下文切换</strong>造成CPU大量的开销</p>
<blockquote>
<p>想想apache的常用工作方式（apache也有异步非阻塞版本，但因其与自带某些模块冲突，所以不常用），<strong>每个请求会独占一个工作线程，当并发数上到几千时，就同时有几千的线程在处理请求了</strong>。这对操作系统来说，是个不小的挑战，线程带来的内存占用非常大，线程的上下文切换带来的cpu开销很大，自然性能就上不去了，而这些开销完全是没有意义的。</p>
</blockquote>
<h5 id="nginx的异步非阻塞">nginx的异步非阻塞</h5><ul>
<li>不需要创建线程，每个请求只占用少量的内存</li>
<li>没有上下文切换，事件处理非常轻量</li>
</ul>
<blockquote>
<p>异步的概念和同步相对的，也就是不是事件之间不是同时发生的。</p>
<p>非阻塞的概念是和阻塞对应的，阻塞是事件按顺序执行，每一事件都要等待上一事件的完成，而非阻塞是如果事件没有准备好，这个事件可以直接返回，过一段时间再进行处理询问，这期间可以做其他事情。但是，多次询问也会带来额外的开销。</p>
</blockquote>
<h5 id="关于apache线程开启销毁；nginx进程开启销毁的开销">关于apache线程开启销毁；nginx进程开启销毁的开销</h5><p>进程的开启关闭的开销大于线程的开启关闭</p>
<ul>
<li>apache,tomcat 每次请求都会开启一个线程，请求处理之后就会销毁</li>
<li>nginx处理逻辑都在worker进程。worker进程中有一个函数，执行无限循环，不断处理收到的来自客户端的请求，并进行处理，直到整个nginx服务被停止。</li>
</ul>
<p>本文参考网址：<a href="http://www.cnblogs.com/coder2012/p/3141469.html" target="_blank" rel="external">http://www.cnblogs.com/coder2012/p/3141469.html</a><br>更多nginx参考：<a href="http://tengine.taobao.org/book/chapter_2.html" target="_blank" rel="external">http://tengine.taobao.org/book/chapter_2.html</a></p>
<h3 id="apache的工作模式">apache的工作模式</h3><p>上文已经讲到“apache每个请求会独占一个工作线程”</p>
<h5 id="prefork工作模式">prefork工作模式</h5><blockquote>
<p> prefork 进程池模型，用在 UNIX 和类似的系统上比较多，主要是由于写起来方便，也容易移植，还不容易出问题。要知道，如果采用线程模型的话，用户线程、内核线程和混合型线程有不同的特性，移植起来就麻烦。prefork 模型，即预先 fork() 出来一些子进程缓冲一下，用一个锁来控制同步，连接到来了就放行一个子进程，让它去处理。</p>
</blockquote>
<h5 id="apache默认是prefork模式">apache默认是prefork模式</h5><blockquote>
<p>prefork是Unix平台上的默认（缺省）MPM，使用多个子进程，每个子进程只有一个线程。<strong>每个进程在某个确定的时间只能维持一个连接，效率高，但内存占用量比较大。</strong><br>本节点参考：<a href="http://www.cnblogs.com/adforce/archive/2013/10/11/3363148.html" target="_blank" rel="external">http://www.cnblogs.com/adforce/archive/2013/10/11/3363148.html</a></p>
</blockquote>
<p>写到这里有些混乱了~~~~<strong>整理一下</strong>：</p>
<ul>
<li>nginx 只启用了多进程,一个进程处理多个请求的非阻塞模式</li>
<li>apache 默认的prefork模式是多个进程，但是一个进程只有一个线程的阻塞模式</li>
<li>apache 非阻塞模式（worker模式），开启多个进程，一个进程中多线程。由于进程切换带来了开销，与prefork模式相比，带来的性能提升不明显，而且worker模式的兼容性挺差</li>
<li>IO模型层面，Nginx选择epoll，Apache选择select </li>
</ul>
<h2 id="PHP的多线程与异步">PHP的多线程与异步</h2><h3 id="php的生命周期">php的生命周期</h3><h5 id="php单进程生命周期">php单进程生命周期</h5><p>首先说一下php的生命周期吧，便于理解，php单进程模式：<br><img src="http://www.walu.cc/phpbook/image/01fig01.jpg" alt=""></p>
<p>SAPI运行PHP都经过下面几个阶段:</p>
<ol>
<li><p>模块初始化阶段(Module init)     ：</p>
<p> 即调用每个拓展源码中的的PHP_MINIT_FUNCTION中的方法初始化模块,进行一些模块所需变量的申请,内存分配等。</p>
</li>
<li><p>请求初始化阶段(Request init)  ：</p>
<p> 即接受到客户端的请求后调用每个拓展的PHP_RINIT_FUNCTION中的方法,初始化PHP脚本的执行环境。</p>
</li>
<li><p>执行PHP脚本</p>
</li>
<li><p>请求结束(Request Shutdown) ：</p>
<p> 这时候调用每个拓展的PHP_RSHUTDOWN_FUNCTION方法清理请求现场,并且    ZE开始回收变量和内存。</p>
</li>
<li><p>关闭模块(Module shutdown)     ：</p>
<p> Web服务器退出或者命令行脚本执行完毕退出会调用拓展源码中的PHP_MSHUTDOWN_FUNCTION 方法</p>
</li>
</ol>
<h5 id="php多进程生命周期">php多进程生命周期</h5><p>图展示了从apache(prefork模式)的视角来看多进程工作模式下的PHP：</p>
<p><img src="http://www.walu.cc/phpbook/image/01fig03.jpg" alt=""></p>
<p><strong>注意</strong>：一个进程处理了多个请求，多个RINIT</p>
<h5 id="php多线程生命周期">php多线程生命周期</h5><p>apache (worker模式)工作示意图：(支持混合的多线程多进程的多路处理模块)</p>
<p><img src="http://www.walu.cc/phpbook/image/01fig04.jpg" alt=""></p>
<p>参考文章:<a href="http://www.walu.cc/phpbook/1.3.md" target="_blank" rel="external">http://www.walu.cc/phpbook/1.3.md</a></p>
<h3 id="php多线程扩展pthreads">php多线程扩展pthreads</h3><p>安装：<br>编译php时需要加上这个参数<code>--enable-maintainer-zts</code><br>如果已经安装了php，直接重新编译就ok</p>
<p>下载pthreads安装包，用phpize编译即可</p>
<p>这个不多说了，我也没用过哈~需要用的时候多查看一下手册，看网上的测试，据说还可以，挺稳定。</p>
<h3 id="php扩展swoole">php扩展swoole</h3><p>google一下“php异步扩展”第一个就是swoole了。腾讯一大牛开源的扩展。</p>
<p>swoole分为扩展和框架。提供了PHP语言的异步多线程服务器。优势非常明显，异步同步、多进程多线程都可以。评价也非常高，不过目前用的人还是比较少。</p>
<p>这个可以上官网学习一下。<a href="http://www.swoole.com/" target="_blank" rel="external">http://www.swoole.com/</a><br>博客：rango.swoole.com</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/process/">process</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-linux-vim" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/02/linux-vim/" class="article-date">
  	<time datetime="2015-04-02T14:01:22.000Z" itemprop="datePublished">2015-04-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/02/linux-vim/">mac下改造vim编辑器</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本地环境：macbook pro 系统：10.10.1 </p>
<h2 id="建造自己的-vimrc">建造自己的.vimrc</h2><p>mac的用户更目录没有自己的vimrc</p>
<pre><code><span class="title">cd</span> <span class="regexp">~
touch</span> .vimrc
</code></pre><h2 id="修改vim的默认编辑主题colorscheme">修改vim的默认编辑主题colorscheme</h2><h4 id="查看主题：">查看主题：</h4><pre><code>ls -l  <span class="regexp">/usr/</span>share<span class="regexp">/vim/</span>vim73<span class="regexp">/colors/</span>
</code></pre><p>里面有mac自带的vim主题，当然你也可以自己去下载vim主题放到这个目录，我用的是默认的<code>evening</code></p>
<p>感觉还不错。哈哈哈</p>
<h4 id="修改主题">修改主题</h4><pre><code><span class="title">vim</span> .vimrc
</code></pre><p>添加:</p>
<pre><code><span class="keyword">colorscheme</span> evening

<span class="string">"顺便设置一下代码高亮，这是php的，也可以去下载php.vim
</span><span class="keyword">syntax</span>   <span class="keyword">on</span> = php 
</code></pre><h2 id="安装ctags">安装ctags</h2><ol>
<li>从<a href="http://ctags.sourceforge.net/下载源代码包后，解压缩生成源代码目录，" target="_blank" rel="external">http://ctags.sourceforge.net/下载源代码包后，解压缩生成源代码目录，</a></li>
<li>进入源代码根目录执行./configure</li>
<li>执行make</li>
<li>执行make install</li>
<li><p>在~/.vimrc中增加以下这行</p>
<pre><code><span class="built_in">map</span> &lt;C-F12&gt; :!ctags -R --c++<span class="variable">-kinds=</span>+p <span class="variable">--fields=</span>+iaS <span class="variable">--extra=</span>+q .&lt;CR&gt;  
<span class="string">"上面的意思是创建一个快捷键 ctrl+F12 可以执行ctags -R 
"</span>进入需要ctags的文件夹更根目录 打开vim 按ctrl+F12即可
</code></pre></li>
<li><p>ctags -R “你需要的文件夹”</p>
</li>
</ol>
<h2 id="安装Taglist">安装Taglist</h2><ol>
<li>下载地址<a href="http://www.vim.org/scripts/script.php?script_id=273" target="_blank" rel="external">http://www.vim.org/scripts/script.php?script_id=273</a></li>
<li>解压把doc plugin下得东西对应放到 ~/.vim/这个文件夹下面的doc plugin下面</li>
<li>进入~/.vim/doc目录，在Vim下运行”helptags .”命令。此步骤是将doc下的帮助文档加入到Vim的帮助主题中，这样我们就可以通过在Vim中运行“help taglist.txt”查看taglist帮助</li>
<li><p>打开.vimrc,添加</p>
<pre><code><span class="keyword">let</span> <span class="variable">Tlist_Show_One_File=</span><span class="number">1</span>
<span class="keyword">let</span> <span class="variable">Tlist_Exit_OnlyWindow=</span><span class="number">1</span>
</code></pre></li>
</ol>
<h2 id="安装Winmanager、NERDTree、MiniBufExplorer">安装Winmanager、NERDTree、MiniBufExplorer</h2><p>1.下载同上，地址：</p>
<pre><code><span class="label">http:</span>//www.vim<span class="preprocessor">.org</span>/scripts/script.php?script_id=<span class="number">1658</span>
<span class="label">http:</span>//www.vim<span class="preprocessor">.org</span>/scripts/script.php?script_id=<span class="number">159</span>
<span class="label">http:</span>//www.vim<span class="preprocessor">.org</span>/scripts/script.php?script_id=<span class="number">95</span>
</code></pre><ol>
<li>安装同上，解压</li>
<li><p>编辑.vimrc </p>
<pre><code><span class="keyword">let</span> g:<span class="variable">miniBufExplMapWindowNavVim =</span> <span class="number">1</span> 
<span class="keyword">let</span> g:<span class="variable">miniBufExplMapWindowNavArrows =</span> <span class="number">1</span> 
<span class="keyword">let</span> g:<span class="variable">miniBufExplMapCTabSwitchBufs =</span> <span class="number">1</span> 
<span class="keyword">let</span> g:<span class="variable">miniBufExplModSelTarget =</span> <span class="number">1</span>
<span class="keyword">let</span> g:<span class="variable">miniBufExplMoreThanOne=</span><span class="number">0</span>

<span class="keyword">let</span> g:<span class="variable">winManagerWindowLayout=</span>'NERDTree|TagList'

<span class="string">"设置WM的快捷键，我设置为w
nmap w :WMToggle&lt;CR&gt;</span>
</code></pre></li>
</ol>
<p>我们可以通过 Ctrl+w 快捷键或鼠标点击在Taglist窗口和编辑区之间切换焦点</p>
<p>winmanager自带的fileexplorer这个插件实在是比较差。最重要的一点是fileexplorer不能自动更新，如果通过其他的途径修改了文件夹中的内容，fileexplorer是不会显示的。相对而言Nerd_Tree功能就比较强大了。下面要把Nerd_Tree加入winmanager</p>
<p><code>sudo vim ~/.vim/plugin/NERD_tree.vim</code><br>//最后添加</p>
<pre><code>let g:NERDTree_title = <span class="string">"[NERDTree]"</span>
<span class="function"><span class="keyword">function</span>! <span class="title">NERDTree_Start</span><span class="params">()</span></span>
    exe <span class="string">'NERDTree'</span>
<span class="function"><span class="keyword">endfunction</span></span>
<span class="function"><span class="keyword">function</span>! <span class="title">NERDTree_IsValid</span><span class="params">()</span></span>
    <span class="keyword">return</span> <span class="number">1</span>
<span class="function"><span class="keyword">endfunction</span></span>
</code></pre><p>我的mac上出现一个小bug 中间多出现一个空得窗口~~~</p>
<p>发现每次打开winmanager都会出现一个空白的buffer。打开winmanager.vim，找到函数function! <sid>ToggleWindowsManager()，加入两行，修改后整个函数如下：</sid></p>
<p><img src="http://ww3.sinaimg.cn/mw690/005ItG0Rtw1eqqgy4jee2j30s208i0ue.jpg" alt=""></p>
<p>图中参数3 代表第几个窗口，（关闭第三个窗口）</p>
<p>到此就结束了，vim一个文件之后，可以使用w快捷键调用wm，ctrl-w切换光标窗口</p>
<p>本文参考网址：<a href="http://blog.csdn.net/bokee/article/details/6633193" target="_blank" rel="external">http://blog.csdn.net/bokee/article/details/6633193</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mac/">mac</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vim/">vim</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-mac-install-new-php" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/01/mac-install-new-php/" class="article-date">
  	<time datetime="2015-03-31T16:11:42.000Z" itemprop="datePublished">2015-04-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/01/mac-install-new-php/">mac下重新编译php新版本</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="解决掉mac自带的php">解决掉mac自带的php</h1><p>我的处理方式有点暴力~ 自己删除文件，把下面的干掉基本自带的php就没有了，还不放心？find一下php</p>
<pre><code><span class="regexp">/private/</span>etc/           sudo rm -rf php-fpm.conf.<span class="keyword">default</span> php.ini php.ini.<span class="keyword">default</span>
<span class="regexp">/usr/</span>bin/               sudo rm -rf php php-config phpdoc phpize
<span class="regexp">/usr/</span>include            sudo rm -rf php
<span class="regexp">/usr/</span>lib                sudo rm -rf php
<span class="regexp">/usr/</span>sbin               sudo rm -rf php-fpm
<span class="regexp">/usr/</span>share              sudo rm -rf php
<span class="regexp">/usr/</span>share<span class="regexp">/man/</span>man1     sudo rm -rf php-config.1 php.1 phpize.1
<span class="regexp">/usr/</span>share<span class="regexp">/man/</span>man8     sudo rm -rf php-fpm.8
</code></pre><p>为什么要重新装php呢？mac下自带的php让人忍受不了，升级了一下系统，发现gd库生成图片不行了~</p>
<h1 id="基本环境的安装">基本环境的安装</h1><h3 id="libpng安装">libpng安装</h3><ul>
<li>下载地址：<a href="http://jaist.dl.sourceforge.net/project/libpng/libpng16/1.6.16/libpng-1.6.16.tar.xz" target="_blank" rel="external">http://jaist.dl.sourceforge.net/project/libpng/libpng16/1.6.16/libpng-1.6.16.tar.xz</a></li>
</ul>
<ul>
<li><p>安装</p>
<pre><code>tar zxf libpng-<span class="number">1.6</span>.<span class="number">16</span><span class="class">.tar</span><span class="class">.xz</span>
cd libpng-<span class="number">1.6</span>.<span class="number">16</span><span class="class">.tar</span><span class="class">.xz</span>
./configure --prefix=/usr/local/libpng
make
make install
</code></pre></li>
</ul>
<h3 id="jpeg安装">jpeg安装</h3><ul>
<li>下载地址 <a href="http://down1.chinaunix.net/distfiles/jpegsrc.v7.tar.gz" target="_blank" rel="external">http://down1.chinaunix.net/distfiles/jpegsrc.v7.tar.gz</a>   【chinaunix】下载站得资源挺靠谱。sourceforge下载还是比较慢得。</li>
<li>安装同上，记得修改安装路径prefix</li>
</ul>
<h3 id="freetype安装">freetype安装</h3><ul>
<li>下载地址：<a href="http://jaist.dl.sourceforge.net/project/freetype/freetype2/2.5.5/freetype-2.5.5.tar.bz2" target="_blank" rel="external">http://jaist.dl.sourceforge.net/project/freetype/freetype2/2.5.5/freetype-2.5.5.tar.bz2</a></li>
</ul>
<h3 id="zlib安装">zlib安装</h3><ul>
<li>mac自带了~~</li>
</ul>
<h3 id="libmcrypt安装">libmcrypt安装</h3><ul>
<li>安装php的时候提示我加密库没有，这个最开始也是下载安装包编译~，不过一直不成功，直接用brew装了</li>
</ul>
<h1 id="php编译">php编译</h1><p>开始进入正题了、先把安装包下载回来，直接上php.net down安装包、5.6： <a href="http://cn2.php.net/distributions/php-5.6.6.tar.gz" target="_blank" rel="external">http://cn2.php.net/distributions/php-5.6.6.tar.gz</a>  解压…..</p>
<h3 id="编译参数">编译参数</h3><p>参数仿照aliyun、记得把fpm参数加上（第一次没加上，重新编译一次）<br>其中apx2 路径需要先查看，libpng、freetype、jpeg参数都是上面编译的路径</p>
<pre><code>./configure --prefix=/usr/local/php \
-<span class="ruby">-with-config-file-path=<span class="regexp">/usr/local</span><span class="regexp">/php/etc</span> \
</span>-<span class="ruby">-with-apxs2=<span class="regexp">/usr/sbin</span><span class="regexp">/apxs \
</span></span>-<span class="ruby">-with-mysql=mysqlnd \
</span>-<span class="ruby">-with-mysqli=mysqlnd \
</span>-<span class="ruby">-with-pdo-mysql=mysqlnd \
</span>-<span class="ruby">-enable-static \
</span>-<span class="ruby">-enable-maintainer-zts \
</span>-<span class="ruby">-enable-zend-multibyte \
</span>-<span class="ruby">-enable-inline-optimization \
</span>-<span class="ruby">-enable-sockets \
</span>-<span class="ruby">-enable-wddx \
</span>-<span class="ruby">-enable-zip \
</span>-<span class="ruby">-enable-fpm \
</span>-<span class="ruby">-with-fpm-user=www \
</span>-<span class="ruby">-with-fpm-group=www \
</span>-<span class="ruby">-enable-calendar \
</span>-<span class="ruby">-enable-bcmath \
</span>-<span class="ruby">-enable-soap \
</span>-<span class="ruby">-with-zlib \
</span>-<span class="ruby">-with-iconv \
</span>-<span class="ruby">-with-gd \
</span>-<span class="ruby">-with-xmlrpc \
</span>-<span class="ruby">-enable-mbstring \
</span>-<span class="ruby">-without-sqlite \
</span>-<span class="ruby">-with-curl \
</span>-<span class="ruby">-enable-ftp \
</span>-<span class="ruby">-with-mcrypt  \
</span>-<span class="ruby">-with-freetype-dir=<span class="regexp">/usr/local</span><span class="regexp">/freetype \
</span></span>-<span class="ruby">-with-jpeg-dir=<span class="regexp">/usr/local</span><span class="regexp">/jpeg \
</span></span>-<span class="ruby">-with-png-dir=<span class="regexp">/usr/local</span><span class="regexp">/libpng
</span></span>

make &amp;&amp; make install
</code></pre><p>这两个参数可以在<code>/usr/local/php/etc/php-fpm.conf</code>里面修改</p>
<pre><code>--<span class="keyword">with</span>-fpm-user=www <span class="string">\</span>
--<span class="keyword">with</span>-fpm-group=www <span class="string">\</span>
</code></pre><p>[其他常见问题<a href="http://blog.csdn.net/dc_726/article/details/9519619" target="_blank" rel="external">http://blog.csdn.net/dc_726/article/details/9519619</a>]</p>
<p>编译完后，设置php全局变量[非必须]；</p>
<p>我是做软链形式<code>sudo ln -s /usr/local/php/bin/php /usr/bin/php</code>，也可以加入全局变量$PATH</p>
<h3 id="php查看模块安装">php查看模块安装</h3><p> php -m | grep pdo</p>
<h3 id="php-fpm_设置：">php-fpm 设置：</h3><p>复制php-fpm配置文件 </p>
<pre><code>cp /usr/local/php/etc/php-fpm<span class="class">.conf</span><span class="class">.default</span> /usr/local/php/etc/php-fpm<span class="class">.conf</span>

vim php-fpm<span class="class">.conf</span>   

<span class="comment">//   #pid = run/php-fpm.pid 将#号去掉</span>
</code></pre><h3 id="php-fpm启动">php-fpm启动</h3><p>以下在mac上没做测试</p>
<p>【fpm开机自启动】</p>
<p>网上有各种版本的php-fpm开机自动启动脚本, 其实你编译后源目录已经生成自动脚本。不用做任何修改即用。</p>
<pre><code>cp {php-5.6.x-source-<span class="keyword">dir</span>}/sapi/fpm/init.<span class="keyword">d</span>.php-fpm /etc/init.<span class="keyword">d</span>/php-fpm
chmod +x /etc/init.<span class="keyword">d</span>/php-fpm
chkconfig --add php-fpm
chkconfig php-fpm <span class="keyword">on</span>
service php-fpm start
</code></pre><p>启动fpm /usr/local/php/sbin/php-fpm </p>
<p>kill fpm 进程 </p>
<p>lsof -i:9000 </p>
<p>sudo kill **</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mac/">mac</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 yidiandianlan
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    

<script src="/js/mobile.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>





  </div>
</body>
</html>